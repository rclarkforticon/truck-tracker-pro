<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TruckTracker | Paving Logistics & Yield</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; padding-bottom: 110px; }
        .progress-bar { transition: width 0.5s ease-in-out; }
        .heavy-glow { box-shadow: 0 0 25px rgba(239, 68, 68, 0.6); border-color: #ef4444 !important; }
        
        @keyframes pulse-red-border { 0% { border-color: #ef4444; box-shadow: 0 0 0px rgba(239,68,68,0); } 50% { border-color: #ef4444; box-shadow: 0 0 15px rgba(239,68,68,0.5); } 100% { border-color: #ef4444; box-shadow: 0 0 0px rgba(239,68,68,0); } }
        .pulse-border { animation: pulse-red-border 2s infinite; border: 2px solid #ef4444 !important; }

        @keyframes pulse-red { 0%, 100% { background-color: #991b1b; } 50% { background-color: #ef4444; } }
        @keyframes pulse-warning { 0%, 100% { background-color: #facc15; } 50% { background-color: #eab308; } }
        .emergency-banner { animation: pulse-red 2s infinite; }
        .warning-banner { animation: pulse-warning 3s infinite; }
        @media print { .no-print { display: none !important; } .print-only { display: block !important; } body { background: white; padding-bottom: 0; } }
        .tab-active { color: #facc15 !important; }
        .tab-active svg { fill: #facc15 !important; }
        input:focus, select:focus { outline: none; border-color: #facc15; ring: 2px #facc15; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen font-medium">

    <!-- AUTHENTICATION VIEW -->
    <div id="view-auth" class="min-h-screen flex items-center justify-center p-6 bg-slate-900">
        <div class="w-full max-w-sm bg-white rounded-3xl shadow-2xl overflow-hidden border-b-8 border-yellow-400">
            <div class="bg-black p-8 text-center text-white">
                <h1 class="text-3xl font-black tracking-tighter italic text-yellow-400 uppercase leading-none mb-2">TruckTracker</h1>
                <p class="text-[10px] text-slate-400 uppercase font-black tracking-[0.2em]">Logistics Management</p>
            </div>
            <div class="p-8 space-y-4">
                <div class="space-y-1">
                    <label class="text-[10px] font-black uppercase text-slate-400 px-1">Email Address</label>
                    <input type="email" id="auth-email" class="w-full border-2 border-slate-100 p-3 rounded-xl font-bold focus:border-yellow-400 transition-colors" placeholder="name@company.com">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-black uppercase text-slate-400 px-1">Password</label>
                    <input type="password" id="auth-pass" class="w-full border-2 border-slate-100 p-3 rounded-xl font-bold focus:border-yellow-400 transition-colors" placeholder="••••••••">
                </div>
                
                <div class="pt-2 flex flex-col space-y-3">
                    <button onclick="handleAuth('login')" class="w-full bg-black text-yellow-400 py-4 rounded-2xl font-black uppercase tracking-widest shadow-lg active:scale-95 transition-transform">Sign In</button>
                    
                    <div class="relative py-2">
                        <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-slate-200"></div></div>
                        <div class="relative flex justify-center text-xs uppercase"><span class="bg-white px-2 text-slate-400 font-bold">Or continue with</span></div>
                    </div>

                    <button onclick="handleGoogleAuth()" class="w-full bg-white border-2 border-slate-100 text-slate-700 py-3.5 rounded-2xl font-bold flex items-center justify-center space-x-3 shadow-sm active:scale-95 transition-transform hover:bg-slate-50">
                        <svg width="20" height="20" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                            <path d="M44.5 20H24v8.5h11.8C34.7 33.9 30.1 37 24 37c-7.2 0-13-5.8-13-13s5.8-13 13-13c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.6 4.1 29.6 2 24 2 11.8 2 24.1 11.8 2 24s9.8 22 22 22c11 0 21-8 21-22 0-1.3-.2-2.7-.5-4z" fill="#4285F4"/><path d="m6.3 14.7 6.6 4.8C14.7 16.2 19.1 14 24 14c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.6 4.1 29.6 2 24 2 16.5 2 9.9 5.2 6.3 10.5l.04.04z" fill="#EA4335"/><path d="M24 46c5.9 0 10.9-2 15.1-5.4l-6.5-5.2c-2.3 1.5-5.3 2.6-8.6 2.6-6.1 0-11.2-4.1-13.1-9.6l-6.7 5.2C7.9 40.5 15.4 46 24 46z" fill="#34A853"/><path d="M10.9 29.4c-1.1-3.2-1.1-6.7 0-9.9l-6.7-5.2C1.4 18.2 1.4 29.8 4.2 34.6l6.7-5.2z" fill="#FBBC05"/>
                        </svg>
                        <span>Sign in with Google</span>
                    </button>

                    <button onclick="handleAuth('signup')" class="w-full text-slate-400 py-2 font-bold text-xs uppercase tracking-widest hover:text-black transition-colors text-center">Create Account with Email</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div id="main-app-container" class="hidden max-w-xl mx-auto no-print">
        <header class="bg-black text-white p-4 sticky top-0 z-50 shadow-lg border-b border-yellow-400/30 text-center">
            <div class="flex justify-between items-center">
                <div class="flex-1">
                    <h1 class="text-xl font-black tracking-tighter italic text-yellow-400 uppercase leading-none" style="filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5)); text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">TruckTracker</h1>
                    <p id="header-job-name" class="text-[10px] text-slate-400 uppercase font-black tracking-[0.15em] mt-1 truncate max-w-[250px] mx-auto"></p>
                </div>
            </div>
        </header>

        <!-- Banners -->
        <div id="traffic-delay-banner" class="hidden emergency-banner text-white p-3 flex items-center justify-between shadow-lg">
            <div class="flex items-center space-x-3 text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="white" viewBox="0 0 256 256" class="animate-bounce"><path d="M236.8,188.09,149.35,36.22a24.76,24.76,0,0,0-42.7,0L19.2,188.09a23.51,23.51,0,0,0,0,23.72A24.34,24.34,0,0,0,40.55,224h174.9a24.34,24.34,0,0,0,21.35-12.19A23.51,23.51,0,0,0,236.8,188.09ZM120,104a8,8,0,0,1,16,0v40a8,8,0,0,1-16,0Zm8,88a12,12,0,1,1,12-12A12,12,0,0,1,128,192Z"></path></svg>
                <div>
                    <p class="text-xs font-black uppercase tracking-tighter mb-1">SIGNIFICANT DELAY</p>
                    <p id="traffic-delay-text" class="text-[10px] font-bold opacity-90"></p>
                </div>
            </div>
            <button onclick="document.getElementById('traffic-delay-banner').classList.add('hidden')" class="font-bold">X</button>
        </div>

        <div id="plant-close-banner" class="hidden warning-banner bg-yellow-400 text-black p-3 flex items-center shadow-lg border-b border-yellow-600/20">
            <div class="flex items-center space-x-3 w-full">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256"><path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm64-88a8,8,0,0,1-8,8H128a8,8,0,0,1-8-8V72a8,8,0,0,1,16,0v40h48A8,8,0,0,1,192,128Z"></path></svg>
                <div class="flex-1">
                    <p class="text-[10px] font-black uppercase tracking-tight leading-none mb-1 text-black">Plant Closing Imminent</p>
                    <p id="plant-close-text" class="text-xs font-bold leading-tight text-black"></p>
                </div>
                <button onclick="dismissPlantBanner()" class="bg-black/10 px-2 py-1 rounded font-black text-xs">HIDE</button>
            </div>
        </div>

        <main id="view-dashboard" class="p-4 space-y-6">
            <!-- Plant Widget -->
            <div class="bg-white rounded-2xl p-5 shadow-sm border border-slate-200 flex items-center justify-between text-black">
                <div class="flex items-center space-x-4 overflow-hidden">
                    <div class="bg-yellow-400 p-3 rounded-2xl text-black shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256"><path d="M248,112h-8V104a16,16,0,0,0-16-16h-4.2l-14.8-44.4A15.9,15.9,0,0,0,190,32H66a15.9,15.9,0,0,0-15,11.6L36.2,88H32a16,16,0,0,0-16,16v8H8a8,8,0,0,0,0,16H16v88a16,16,0,0,0,16,16H224a16,16,0,0,0,16-16V128h8a8,8,0,0,0,0-16ZM66,48H190l13.33,40H52.67ZM224,216H32V104H224V216ZM128,144a16,16,0,1,1-16,16A16,16,0,0,1,128,144Z"></path></svg>
                    </div>
                    <div class="overflow-hidden">
                        <p id="display-plant-name" class="font-black text-black leading-none text-sm uppercase truncate">No Plant Selected</p>
                        <p id="display-sales-rep" class="text-slate-400 font-bold text-[10px] uppercase mt-1 tracking-wider truncate">No Sales Rep Set</p>
                    </div>
                </div>
                <a id="sales-rep-call-btn" href="tel:" class="bg-black text-yellow-400 p-3 rounded-2xl shadow-lg active:scale-90 transition-transform shrink-0 hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256"><path d="M222.37,158.46l-47.11-21.11-.13-.06a16,16,0,0,0-15.17,1.4,8.12,8.12,0,0,0-.75.56L143.16,155.3c-23.51-12.82-41.69-31-54.51-54.51l16.05-16.05a8.12,8.12,0,0,0,.56-.75,16,16,0,0,0,1.34-15.3l-.06-.13L85.44,41.43a16,16,0,0,0-18.42-9.28L35,39.69a16,16,0,0,0-12.44,14c-1.56,22.25,2.4,59.3,27.1,95s72.71,114.65,138.81,114.65l6.53,0a16,16,0,0,0,14.07-12.44l7.54-32A16,16,0,0,0,222.37,158.46Z"></path></svg>
                </a>
            </div>

            <!-- Cycle Times -->
            <div id="travel-widget" class="bg-white rounded-2xl shadow-xl border-2 border-slate-200 overflow-hidden ring-4 ring-slate-100 transition-all duration-500">
                <div class="bg-slate-900 px-4 py-2 border-b-4 border-yellow-400 flex justify-between items-center text-white">
                    <div>
                        <h3 class="font-black text-xs uppercase tracking-tighter italic">Truck Cycle Times</h3>
                        <p class="text-[8px] text-yellow-400/70 font-black uppercase tracking-widest leading-none">Super10 Dynamics</p>
                    </div>
                    <button onclick="updateLiveTraffic()" class="bg-yellow-400 text-black px-2 py-1 rounded text-[9px] font-black uppercase shadow-sm">Refresh</button>
                </div>
                <div class="p-4 grid grid-cols-2 gap-3 bg-slate-50/50 text-black">
                    <div class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm text-center">
                        <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Hotplant → Jobsite</p>
                        <p id="travel-forward" class="text-3xl font-black tabular-nums">-- <span class="text-xs text-slate-400">m</span></p>
                    </div>
                    <div class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm text-center">
                        <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Jobsite → Hotplant</p>
                        <p id="travel-return" class="text-3xl font-black tabular-nums">-- <span class="text-xs text-slate-400">m</span></p>
                    </div>
                </div>
            </div>

            <!-- MAIN DATA TALLY -->
            <div class="bg-black text-white rounded-2xl shadow-2xl p-6 relative overflow-hidden border-b-4 border-yellow-400">
                <div class="relative z-10">
                    <div class="flex justify-between items-end mb-4">
                        <div>
                            <p class="text-[10px] font-black uppercase tracking-[0.2em] text-yellow-400 mb-1 opacity-60">Tons Received</p>
                            <h2 class="text-7xl font-black tabular-nums tracking-tighter leading-none text-yellow-400" id="display-received">0.0</h2>
                        </div>
                        <div class="text-right pb-1">
                            <p class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-500 mb-1 leading-none">Truck Count</p>
                            <h2 class="text-2xl font-black opacity-40"><span id="display-loads-count">0</span><span class="text-sm mx-0.5">/</span><span id="display-loads-goal">--</span></h2>
                        </div>
                    </div>
                    <div class="w-full bg-slate-900 h-4 rounded-full overflow-hidden mb-3 border border-slate-800">
                        <div id="progress-bar" class="progress-bar bg-yellow-400 h-full w-0"></div>
                    </div>
                    <div class="flex justify-between text-[10px] font-black text-slate-500 uppercase tracking-widest">
                        <span>Goal Completion</span>
                        <span>Remaining: <span id="display-remaining" class="text-yellow-400">0</span> t</span>
                    </div>
                </div>
            </div>

            <!-- Yield Guard -->
            <div class="bg-black text-white rounded-2xl shadow-xl p-5 border-2 border-transparent transition-all duration-500" id="yield-card">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-xs uppercase tracking-[0.2em] text-slate-500">Yield Guard</h3>
                    <div id="yield-badge" class="px-2 py-1 rounded text-[10px] font-black uppercase bg-slate-800 text-yellow-400 border border-yellow-400/20">Ready</div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] uppercase font-black opacity-40 mb-1">SQ FT Paved</label>
                        <input type="number" id="input-sf" placeholder="Enter SF" oninput="calculateYield()" class="w-full bg-slate-900 border-slate-800 border p-3 rounded-xl text-2xl font-black text-yellow-400 focus:ring-2 focus:ring-yellow-400">
                    </div>
                    <div class="flex flex-col justify-center text-white">
                        <p class="text-[10px] uppercase font-black opacity-40 mb-1 leading-none mb-1 text-slate-400">Theo. Needed</p>
                        <p class="text-3xl font-black text-yellow-400" id="display-theoretical">0.0</p>
                    </div>
                </div>
            </div>

            <!-- Detailed History -->
            <div class="bg-white rounded-2xl shadow-xl border-2 border-slate-200 overflow-hidden ring-4 ring-slate-100">
                <div class="bg-slate-900 p-4 border-b-4 border-yellow-400 flex justify-between items-center text-white">
                    <div>
                        <h3 class="font-black text-xl uppercase tracking-tighter italic">Detailed History</h3>
                        <p class="text-[9px] text-yellow-400/70 font-black uppercase tracking-widest leading-none mt-1">Live Material Log</p>
                    </div>
                    <button onclick="clearHistory()" class="bg-red-600 text-white hover:bg-red-700 px-3 py-1.5 rounded-lg text-[10px] font-black uppercase shadow-sm">Clear Log</button>
                </div>

                <div class="bg-slate-50 p-5 border-b-2 border-slate-200 shadow-inner">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4 text-center">New Arrival Intake</p>
                    <div class="space-y-4 text-black">
                        <div class="grid grid-cols-2 gap-3 text-black">
                            <div class="space-y-1">
                                <label class="text-[9px] font-black text-slate-400 uppercase px-1">Net Tonnage</label>
                                <input type="number" id="new-load-tons" placeholder="0.00" step="0.01" class="w-full border-2 border-slate-200 p-3 rounded-xl text-xl font-black bg-white focus:border-yellow-400 text-black">
                            </div>
                            <div class="space-y-1">
                                <label class="text-[9px] font-black text-slate-400 uppercase px-1">Assign Truck</label>
                                <select id="new-load-truck" class="w-full border-2 border-slate-200 p-3 rounded-xl text-sm font-bold bg-white focus:border-yellow-400 text-black h-[52px]"></select>
                            </div>
                        </div>
                        <button onclick="triggerScanner()" id="scanner-btn" class="w-full flex items-center justify-center space-x-3 bg-black text-yellow-400 py-4 rounded-xl font-black uppercase tracking-widest shadow-lg border border-yellow-400/20 active:scale-95 transition-transform">
                            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 256 256"><path d="M208,56H180.28L166.65,35.56A8,8,0,0,0,160,32H96a8,8,0,0,0-6.65,3.56L75.72,56H48A24,24,0,0,0,24,80V192a24,24,0,0,0,24,24H208a24,24,0,0,0,24-24V80A24,24,0,0,0,208,56Zm8,136a8,8,0,0,1-8,8H48a8,8,0,0,1-8-8V80a8,8,0,1,1,8-8H80a8,8,0,0,0,6.65-3.56L100.28,48h55.44l13.63,20.44A8,8,0,0,0,176,72h32a8,8,0,0,1,8,8ZM128,88a44,44,0,1,0,44,44A44.05,44.05,0,0,0,128,88Zm0,72a28,28,0,1,1,28-28A28,28,0,0,1,128,160Z"></path></svg>
                            <span>Scan Weigh Ticket</span>
                        </button>
                        <button onclick="addLoad()" class="w-full bg-white border-2 border-slate-200 py-2.5 rounded-xl text-slate-500 font-black uppercase text-[10px] tracking-widest hover:bg-slate-100 transition-colors">Log Manual Entry</button>
                        <input type="file" id="ticket-file" accept="image/*" capture="environment" class="hidden" onchange="handleImageUpload(event)">
                    </div>
                </div>
                <div id="load-list" class="divide-y divide-slate-100 max-h-[450px] overflow-y-auto bg-white text-black"></div>
            </div>
        </main>

        <!-- FLEET TAB -->
        <main id="view-fleet" class="hidden p-4 space-y-4">
            <div class="bg-white rounded-2xl shadow-sm border p-4 text-black text-black">
                <h3 class="font-black text-xs text-slate-400 mb-3 text-center uppercase tracking-widest text-black">Unit Registration</h3>
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-2 text-black text-black text-black">
                        <input type="text" id="fleet-id" placeholder="Unit #" class="border p-3 rounded-xl font-bold bg-slate-50 uppercase text-black">
                        <input type="text" id="fleet-driver" placeholder="Driver" class="border p-3 rounded-xl font-bold bg-slate-50 text-black">
                    </div>
                    <input type="tel" id="fleet-phone" placeholder="Cell Number" class="w-full border p-3 rounded-xl font-bold bg-slate-50 text-black">
                    <button onclick="addTruck()" class="w-full bg-black text-yellow-400 py-3 rounded-xl font-black uppercase shadow-lg border border-yellow-400/20 text-yellow-400">Add Truck</button>
                </div>
            </div>
            <div id="fleet-list" class="space-y-3 pb-8 text-black"></div>
        </main>

        <!-- CONFIG TAB -->
        <main id="view-settings" class="hidden p-4 space-y-4 text-black">
            <div class="bg-white rounded-2xl shadow-sm border p-6 text-black">
                <h2 class="text-sm font-black uppercase text-slate-500 mb-6 tracking-widest text-center border-b pb-2 text-black text-black">Project Configuration</h2>
                <div class="space-y-4">
                    <div class="space-y-1">
                        <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest text-black">Project Details</label>
                        <input type="text" id="setup-job-po" placeholder="Job/PO #" class="w-full border p-3 rounded-xl bg-slate-50 font-bold mb-2">
                        <div class="flex space-x-1">
                            <input type="text" id="setup-job-address" placeholder="Job Street Address" class="flex-1 border p-3 rounded-xl bg-slate-50 font-bold text-black text-black">
                            <button onclick="findClosestPlant()" id="plant-search-btn" class="bg-black text-yellow-400 px-4 rounded-xl font-bold border border-yellow-400/20 active:bg-yellow-400 active:text-black shadow-md text-yellow-400">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256"><path d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z"></path></svg>
                            </button>
                        </div>
                    </div>

                    <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200">
                        <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 text-black text-black">Paving Requirements</label>
                        <div class="grid grid-cols-2 gap-3 mb-3 text-black text-black">
                            <div>
                                <label class="block text-[9px] font-bold text-slate-400 uppercase">Est. SQ FT</label>
                                <input type="number" id="setup-job-sf" placeholder="Enter SF" oninput="autoCalculateTonsAndLoads()" class="w-full border p-3 rounded-xl bg-white font-bold text-black text-black">
                            </div>
                            <div>
                                <label class="block text-[9px] font-bold text-slate-400 uppercase">Mat Depth (IN)</label>
                                <input type="number" id="setup-depth" placeholder="Depth" oninput="autoCalculateTonsAndLoads()" class="w-full border p-3 rounded-xl bg-white font-bold text-black text-black">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 text-black">
                            <div>
                                <label class="block text-[9px] font-bold text-slate-400 uppercase text-black text-black">Tons Goal</label>
                                <input type="number" id="setup-total-tons" placeholder="Tons" class="w-full border p-3 rounded-xl bg-white font-bold text-black">
                            </div>
                            <div>
                                <label class="block text-[9px] font-bold text-slate-400 uppercase text-black text-black text-black">Planned Loads</label>
                                <input type="number" id="setup-planned-loads" placeholder="Loads" class="w-full border p-3 rounded-xl bg-white font-bold text-black text-black">
                            </div>
                        </div>
                    </div>

                    <div class="space-y-1">
                        <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest text-black">Hotplant Selection</label>
                        <select id="setup-plant-name" onchange="window.handlePlantSelect(this.value)" class="w-full border p-3 rounded-xl bg-white font-bold mb-2 text-black text-black"></select>
                        <input type="text" id="setup-plant-address" placeholder="Facility Address" class="w-full border p-3 rounded-xl bg-slate-50 font-bold mb-2">
                        <div class="grid grid-cols-2 gap-2 text-black">
                            <input type="text" id="setup-sales-rep" placeholder="Sales Rep" class="border p-3 rounded-xl bg-slate-50 font-bold text-black text-black">
                            <input type="tel" id="setup-sales-phone" placeholder="Rep Phone #" class="border p-3 rounded-xl bg-slate-50 font-bold text-black">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 gap-3 text-black">
                        <div>
                            <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest text-black">Plant Close</label>
                            <input type="time" id="setup-plant-close" value="15:30" class="w-full border p-3 rounded-xl bg-slate-50 font-bold">
                        </div>
                    </div>

                    <div class="pt-6 border-t border-slate-100 text-center text-black">
                        <button onclick="handleSignOut()" class="w-full bg-slate-100 text-slate-400 py-3 rounded-xl font-bold uppercase text-[10px] tracking-widest hover:bg-red-50 hover:text-red-500 transition-all text-center text-center">Sign Out Account</button>
                    </div>

                    <button onclick="saveSetup()" class="w-full bg-black text-yellow-400 py-4 rounded-2xl font-black uppercase tracking-widest shadow-lg border border-yellow-400/30 mt-4 active:scale-95 transition-transform text-yellow-400">Save Parameters</button>
                </div>
            </div>
        </main>
    </div>

   <!-- BOTTOM NAVIGATION -->
<nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 bg-black border-t border-yellow-400/20 flex justify-around p-3 z-50 no-print shadow-2xl hidden">
  <button type="button" data-tab="dashboard" id="nav-dashboard" class="flex flex-col items-center p-2 tab-active transition-all">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256"><path d="M224,120v88a16,16,0,0,1-16,16H160a8,8,0,0,1-8-8V160H104v48a8,8,0,0,1-8,8H48a16,16,0,0,1-16-16V120a8,8,0,0,1,2.34-5.66l80-80a8,8,0,0,11.32,0l80,80A8,8,0,0,1,224,120Z"></path></svg>
    <span class="nav-label text-[9px] font-black mt-1 uppercase tracking-widest text-[#facc15]">Dashboard</span>
  </button>

  <button type="button" data-tab="fleet" id="nav-fleet" class="flex flex-col items-center p-2 text-slate-500 transition-all">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256"><path d="M245.52,142.17l-14.45-50.58A24,24,0,0,0,208,72H48a24,24,0,0,0-23.07,19.59L10.48,142.17A23.9,23.9,0,0,0,8,152v48a16,16,0,0,0,16,16H232a16,16,0,0,0,16-16V152A23.9,23.9,0,0,0,245.52,142.17ZM48,88H208a8,8,0,1,1,7.69,5.8l13.72,48a8,8,0,0,1,.59,3L230,144.83,212.83,128H43.17L26,144.83,26,142.17l14.31-50.11A8,8,0,0,1,48,88ZM232,200H24V161.43l13.43-13.43a8,8,0,0,1,11.31,0L67.43,166.7a8,8,0,0,0,11.31,0l26.63-26.63a8,8,0,0,1,11.31,0L143.4,166.7a8,8,0,0,0,11.31,0l26.63-26.63a8,8,0,1,1,11.31,0l18.66,18.66,20.69,20.69V200ZM72,112a8,8,0,0,1-8,8H48a8,8,0,0,1,0-16H64A8,8,0,0,1,72,112Zm136,8a8,8,0,0,0,0-16H192a8,8,0,0,0,0,16Z"></path></svg>
    <span class="nav-label text-[9px] font-black mt-1 uppercase tracking-widest text-slate-400">Fleet</span>
  </button>

  <button type="button" data-tab="settings" id="nav-settings" class="flex flex-col items-center p-2 text-slate-500 transition-all">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256"><path d="M236.46,147.21l-19.46-13.62a8,8,0,0,1-3.21-6.57V129a8,8,0,1,1,3.21-6.57l19.46-13.62a8,8,0,0,0,2.15-11.23L223.11,72.4a8,8,0,0,0-10.74-2.84l-20.89,11.41a8,8,0,0,1-8.52-.75,81.16,81.16,0,0,0-13.92-8.03,8,8,0,0,1-4.71-7.14l-2.48-23.63a8,8,0,0,0-8-7.16H120a8,8,0,0,0-8,7.16l-2.48,23.63a8,8,0,0,1-4.71,7.14,81.16,81.16,0,0,0-13.92,8.03,8,8,0,0,1-8.52,.75L61.48,69.56a8,8,0,0,0-10.74,2.84L35.25,97.58a8,8,0,0,0,2.15,11.23l19.46,13.62a8,8,0,0,1,3.21,6.57v2.02a8,8,0,0,1-3.21,6.57L37.4,151.21a8,8,0,0,0-2.15,11.23l15.49,25.18a8,8,0,0,0,10.74,2.84l20.89-11.41a8,8,0,0,1,8.52,.75,81.16,81.16,0,0,0,13.92,8.03,8,8,0,0,1,4.71,7.14l2.48,23.63a8,8,0,0,0,8,7.16h32.14a8,8,0,0,0,8-7.16l2.48-23.63a8,8,0,0,1,4.71-7.14,81.16,81.16,0,0,0,13.92,8.03,8,8,0,0,1,8.52,.75l20.89,11.41a8,8,0,0,0,10.74-2.84l15.49-25.18A8,8,0,0,0,236.46,147.21ZM128,156a28,28,0,1,1,28-28A28,28,0,0,1,128,156Z"></path></svg>
    <span class="nav-label text-[9px] font-black mt-1 uppercase tracking-widest text-slate-400">Config</span>
  </button>

  <button type="button" id="nav-report" class="flex flex-col items-center p-2 text-slate-500 hover:text-yellow-400 transition-all">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256"><path d="M200,32H56A16,16,0,0,0,40,48V208a16,16,0,0,0,16,16H200a16,16,0,0,0,16-16V48A16,16,0,0,0,200,32Zm0,176H56V48H200V208ZM184,96a8,8,0,0,1-8,8H80a8,8,0,0,1,0-16h96A8,8,0,0,1,184,96Zm0,32a8,8,0,0,1-8,8H80a8,8,0,0,1,0-16h96A8,8,0,0,1,184,128Zm0,32a8,8,0,0,1-8,8H80a8,8,0,0,1,0-16h96A8,8,0,0,1,184,160Z"></path></svg>
    <span class="nav-label text-[9px] font-black mt-1 uppercase tracking-widest text-center text-slate-400">Run report</span>
  </button>
</nav>


    <div id="toast" class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-black text-yellow-400 px-6 py-3 rounded-full shadow-2xl transition-opacity opacity-0 pointer-events-none z-[200] font-black text-xs uppercase tracking-widest border border-yellow-400/30 text-center">Action Applied</div>

    <!-- MODULE SCRIPT AT BOTTOM OF BODY -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            GoogleAuthProvider,
            signInWithPopup,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONSTANTS ---
        const PLANT_DB = [
            { lng: -118.4033884, lat: 37.41938687, name: "Granite: Bishop Facility", rep: "Angela McAbee", phone: "(661) 331-3215", addr: "5 Bridges Road, Bishop, CA. 93514" },
            { lng: -121.880199, lat: 37.57599303, name: "Martin Marietta: Sunol", rep: "Mark Weiler", phone: "(925) 519-6828", addr: "7999 Athenour Way, Sunol CA 94586" },
            { lng: -121.860825, lat: 38.01463303, name: "Antioch Building Materials: Antioch", rep: "Niels Larsen", phone: "(510) 382-0119", addr: "Antioch, CA" },
            { lng: -122.061823, lat: 38.00167903, name: "County Quarry: Concord", rep: "Chris Gray", phone: "(925) 383-7464", addr: "5501 Imhoff Drive, Martinez CA 94553" },
            { lng: -122.72286, lat: 38.38536203, name: "Vulcan: Todd Road Plant", rep: "Cori Selke", phone: "(707) 302-9247", addr: "Todd Road, Santa Rosa, CA" },
            { lng: -122.45297, lat: 37.98642203, name: "Dutra Group: San Rafael", rep: "Sales", phone: "(415) 459-7740", addr: "2350 Kerner Blvd., San Rafael, CA 94901" },
            { lng: -122.393506, lat: 37.89249703, name: "Dutra Group: Richmond", rep: "Sales", phone: "(415) 459-7740", addr: "Richmond, CA" },
            { lng: -122.253401, lat: 38.21980603, name: "Vulcan: Napa Green Island", rep: "Cori Selke", phone: "(707) 302-9247", addr: "1000 Green Island Rd, American Canyon, CA 94503" },
            { lng: -122.180765, lat: 38.11062003, name: "Vulcan: Vallejo Lake Herman", rep: "Cori Selke", phone: "(707) 302-9247", addr: "885 Lake Herman Road, Vallejo, CA 94591" },
            { lng: -122.043697, lat: 37.62534503, name: "Vulcan: Hayward Facility", rep: "Niels Larsen", phone: "(510) 382-0119", addr: "Hayward, CA" },
            { lng: -121.144865, lat: 37.74735203, name: "Vulcan: Manteca Facility", rep: "Niels Larsen", phone: "(510) 382-0119", addr: "Manteca, CA" },
            { lng: -121.282869, lat: 37.49845903, name: "Vulcan: Vernalis Facility", rep: "Niels Larsen", phone: "(510) 382-0119", addr: "Vernalis, CA" },
            { lng: -120.67139, lat: 36.87768503, name: "Vulcan: Los Banos Facility", rep: "Corina Montoya", phone: "(559) 434-8937", addr: "Los Banos, CA" },
            { lng: -121.886361, lat: 37.338208, name: "Vulcan: San Jose Facility", rep: "Niels Larsen", phone: "(510) 382-0119", addr: "San Jose, CA" },
            { lng: -121.164391, lat: 38.681141, name: "Vulcan: Folsom Facility", rep: "Mark Weiler", phone: "(925) 519-6828", addr: "Folsom, CA" },
            { lng: -121.3654, lat: 38.5234, name: "Granite: Sacramento Facility", rep: "Mark Weiler", phone: "(925) 519-6828", addr: "8675 Kiefer Blvd, Sacramento, CA 95826" },
            { lng: -119.7871, lat: 36.7378, name: "Granite: Central Fresno", rep: "Corina Montoya", phone: "(559) 434-8937", addr: "Central Fresno, CA" },
            { lng: -119.1408, lat: 34.2705, name: "Vulcan: Saticoy Facility", rep: "Nicole Rodriguez", phone: "(626) 221-4293", addr: "6029 Vineyard Avenue Oxnard, CA 93036" },
            { lng: -118.8051, lat: 35.0297, name: "Granite: Solari Facility", rep: "Angela McAbee", phone: "(661) 331-3215", addr: "8999 Capacity Street, Arvin, CA 93203" },
            { lng: -118.1641, lat: 35.0281, name: "Vulcan: Mojave Asphalt Terminal", rep: "Tim Redd", phone: "(323) 833-8388", addr: "1873 Purdy Ave, Mojave, CA 93501" },
            { lng: -117.0780, lat: 32.8085, name: "Vulcan: Mission Gorge Asphalt", rep: "Sales", phone: "(760) 690-5701", addr: "7500 Mission Gorge Rd., San Diego, CA 92120" },
            { lng: -117.3411, lat: 34.6129, name: "Vulcan: Oro Grande Asphalt", rep: "Nicole Rodriguez", phone: "(626) 221-4293", addr: "20181 National Trails Highway Oro Grande, CA. 92368" },
            { lng: -119.1786, lat: 35.0463, name: "Vulcan: San Emidio Asphalt", rep: "Corina Montoya", phone: "(559) 434-8937", addr: "Hwy 166 W Of Old River Rd. Bakersfield, CA. 93313" }
        ].sort((a, b) => a.name.localeCompare(b.name));

        const proxyUrl = "/.netlify/functions/gemini";

        // --- FIREBASE CONFIGURATION ---
        let firebaseConfig;
        if (typeof __firebase_config !== "undefined") {
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
            firebaseConfig = {
                apiKey: "AIzaSyBYSkFXUCVrRbWR_x2vKlETnB-bTaPitpQ",
                authDomain: "trucktracker-90dad.firebaseapp.com",
                projectId: "trucktracker-90dad",
                storageBucket: "trucktracker-90dad.firebasestorage.app",
                messagingSenderId: "437299264555",
                appId: "1:437299264555:web:f21f05ad0b5c031a28be6e",
                measurementId: "G-MYJQ26Z2KF"
            };
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const activeAppId = typeof __app_id !== "undefined" ? __app_id : "trucktracker-production";

        let user = null;
        window.state = window.state || {
            jobPo: "", jobAddress: "", jobSf: "",
            plantName: "No Plant Selected", plantAddress: "", plantPhone: "",
            salesRep: "Unassigned", salesRepPhone: "",
            totalGoal: "", plannedLoads: "", inches: "",
            plantClosing: "15:30", travelTimeForward: 0, travelTimeReturn: 0,
            baselineForward: 0, baselineReturn: 0,
            loads: [], fleet: [], avgTruckSize: 18.0,
            trafficIncident: null, activeTab: "dashboard",
            plantBannerDismissed: false
        };

        // --- AUTHENTICATION ---
        window.handleAuth = async (mode) => {
            const emailEl = document.getElementById("auth-email");
            const passEl = document.getElementById("auth-pass");
            const email = emailEl?.value?.trim();
            const pass = passEl?.value;
            if (!email || !pass) return window.showToast?.("Email/Pass Required");
            try {
                if (mode === "signup") {
                    await createUserWithEmailAndPassword(auth, email, pass);
                    window.showToast?.("Account Created");
                } else {
                    await signInWithEmailAndPassword(auth, email, pass);
                    window.showToast?.("Welcome Back");
                }
            } catch (e) {
                console.error(e);
                if (e.code === 'auth/operation-not-allowed') {
                    window.showToast?.("Enable Email/Pass in Firebase Console.");
                } else if (e.code === 'auth/unauthorized-domain') {
                    const domain = window.location.hostname;
                    window.showToast?.(`Domain ${domain} not authorized. Add it to your Firebase Console settings.`);
                } else {
                    window.showToast?.(String(e.message || e).replace("Firebase: ", ""));
                }
            }
        };

        window.handleGoogleAuth = async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                window.showToast?.("Signed in with Google");
            } catch (e) {
                console.error(e);
                if (e.code === 'auth/unauthorized-domain') {
                    const domain = window.location.hostname;
                    window.showToast?.(`Domain ${domain} not whitelisted in Firebase Console.`);
                } else {
                    window.showToast?.("Google Sign-In failed.");
                }
            }
        };

        window.handleSignOut = async () => {
            await signOut(auth);
            window.showToast?.("Signed Out");
            location.reload();
        };

        // DOM-SAFE AUTH LISTENER
        window.addEventListener('DOMContentLoaded', () => {
            wireBottomNav();
            onAuthStateChanged(auth, (u) => {
                user = u;
                const viewAuth = document.getElementById('view-auth');
                const mainApp = document.getElementById('main-app-container');
                const bottomNav = document.getElementById('bottom-nav');

                if (!viewAuth || !mainApp || !bottomNav) return;

                if (user) {
                    viewAuth.classList.add('hidden');
                    mainApp.classList.remove('hidden');
                    bottomNav.classList.remove('hidden');
                    syncData();
                } else {
                    viewAuth.classList.remove('hidden');
                    mainApp.classList.add('hidden');
                    bottomNav.classList.add('hidden');
                }
            });
        });

        function syncData() {
            if (!user) return;
            const docRef = doc(db, "artifacts", activeAppId, "users", user.uid, "projectData", "currentJob");
            onSnapshot(docRef, (snap) => {
                if (snap.exists()) {
                    window.state = { ...window.state, ...snap.data() };
                    window.updateUI();
                }
            }, (err) => console.error("Firestore Error:", err));
        }

        window.saveToCloud = async () => {
            if (!user) return;
            const docRef = doc(db, "artifacts", activeAppId, "users", user.uid, "projectData", "currentJob");
            try {
                await setDoc(docRef, window.state, { merge: true });
            } catch (e) { console.error("Save Error", e); }
        };

        // UI & Tab Logic
        window.showToast = (m) => { const t = document.getElementById('toast'); if(t) { t.innerText = m; t.style.opacity = '1'; setTimeout(() => t.style.opacity = '0', 4000); } };

        window.updateUI = () => {
            const s = window.state;
            const loads = s.loads || [];
            const received = loads.reduce((sum, l) => sum + l.tons, 0);
            const currentCount = loads.length;
            const liveAvg = currentCount > 0 ? (received / currentCount) : (s.avgTruckSize || 18.0);
            const remaining = Math.max(0, s.totalGoal - received);
            const progress = (received / (s.totalGoal || 1)) * 100;

            const update = (id, val) => { const el = document.getElementById(id); if(el) el.innerText = val; };
            update('display-loads-count', currentCount);
            update('display-loads-goal', s.plannedLoads || "--");
            update('display-received', received.toFixed(1));
            update('display-remaining', remaining.toFixed(1));
            update('display-avg-size', liveAvg.toFixed(1));
            
            const pb = document.getElementById('progress-bar');
            if(pb) pb.style.width = `${Math.min(100, progress)}%`;
            
            const header = document.getElementById('header-job-name');
            if(header) header.innerText = (s.jobPo && s.jobAddress) ? `${s.jobPo} - ${s.jobAddress}` : (s.jobPo || s.jobAddress || "Load Console");

            update('display-plant-name', s.plantName || "No Plant Selected");
            update('display-sales-rep', s.salesRep || "No Sales Rep Set");
            update('travel-forward', `${s.travelTimeForward || '--'} m`);
            update('travel-return', `${s.travelTimeReturn || '--'} m`);

            const callBtn = document.getElementById('sales-rep-call-btn');
            if (callBtn) {
                if (s.salesRepPhone) {
                    callBtn.href = `tel:${s.salesRepPhone.replace(/[^0-9]/g, '')}`;
                    callBtn.classList.remove('hidden');
                } else { callBtn.classList.add('hidden'); }
            }

            if (s.activeTab === 'settings') {
                const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ""; };
                setVal('setup-job-address', s.jobAddress);
                setVal('setup-job-po', s.jobPo);
                setVal('setup-job-sf', s.jobSf);
                setVal('setup-plant-address', s.plantAddress);
                setVal('setup-sales-rep', s.salesRep);
                setVal('setup-sales-phone', s.salesRepPhone);
                setVal('setup-total-tons', s.totalGoal);
                setVal('setup-planned-loads', s.plannedLoads);
                setVal('setup-depth', s.inches);
                setVal('setup-plant-close', s.plantClosing);

                const pN = document.getElementById('setup-plant-name');
                if(pN) pN.innerHTML = '<option value="">Select Facility</option>' + PLANT_DB.map(p => `<option value="${p.name}" ${s.plantName === p.name ? 'selected' : ''}>${p.name}</option>`).join('');
            }

            window.calculateLogistics(); window.renderHistory(); window.calculateYield();
            
            ['view-dashboard', 'view-fleet', 'view-settings'].forEach(v => {
                const el = document.getElementById(v);
                if(el) el.classList.toggle('hidden', v !== `view-${s.activeTab}`);
            });

            ['dashboard', 'fleet', 'settings'].forEach(tab => {
                const navBtn = document.getElementById(`nav-${tab}`);
                if(navBtn) {
                    navBtn.className = `flex flex-col items-center p-2 ${s.activeTab === tab ? 'tab-active' : 'text-slate-500'}`;
                    const label = navBtn.querySelector('.nav-label');
                    if(label) label.className = `nav-label text-[9px] font-black mt-1 uppercase tracking-widest ${s.activeTab === tab ? 'text-[#facc15]' : 'text-slate-400'}`;
                }
            });
        };

        window.switchTab = (tab) => {
            window.closeReport();
            window.state.activeTab = tab;
            window.updateUI();
            if (tab === 'fleet') window.renderFleet();
        };

        function wireBottomNav() {
  // Tabs (Dashboard/Fleet/Settings)
  document.querySelectorAll('#bottom-nav [data-tab]').forEach((btn) => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      const tab = btn.getAttribute('data-tab');
      if (typeof window.switchTab === 'function') window.switchTab(tab);
    });
  });

  // Report button
  const reportBtn = document.getElementById('nav-report');
  if (reportBtn) {
    reportBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      if (typeof window.generateReport === 'function') window.generateReport();
    });
  }
}

        window.renderHistory = () => {
            const list = document.getElementById('load-list'); if(!list) return;
            list.innerHTML = window.state.loads.map((l, i) => `
                <div class="p-4 flex justify-between items-center hover:bg-yellow-50 transition border-l-4 border-transparent hover:border-yellow-400 bg-white">
                    <div class="text-black">
                        <div class="flex items-center space-x-2">
                            <span class="text-[10px] font-black bg-slate-900 text-yellow-400 px-2 py-0.5 rounded italic">Load #${window.state.loads.length - i}</span>
                            <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Unit ${l.truckId}</span>
                        </div>
                        <p class="font-black text-2xl text-slate-900 leading-none mt-2 text-black">${l.tons.toFixed(2)} <span class="text-sm text-slate-400 font-bold uppercase tracking-tighter italic">tons</span></p>
                    </div>
                    <div class="flex flex-col items-end space-y-2">
                        <span class="text-[10px] font-black text-slate-500 bg-slate-200 px-2 py-1 rounded-md border border-slate-300 shadow-sm text-black">${l.time}</span>
                        <button onclick="removeLoad(${l.id})" class="text-slate-300 hover:text-red-500 transition-colors text-black">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 256 256"><path d="M216,48H176V40a24,24,0,0,0-24-24H104A24,24,0,0,0,80,40v8H40a8,8,0,0,0,0,16h8V208a16,16,0,0,0,16,16H192a16,16,0,0,0,16-16V64h8a8,8,0,0,0,0-16ZM96,40a8,8,0,0,1,8-8h48a8,8,0,0,1,8,8v8H96Zm96,168H64V64H192ZM112,104v64a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Zm48,0v64a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Z"></path></svg>
                        </button>
                    </div>
                </div>`).join('') || '<div class="p-12 text-center text-slate-400 italic text-sm font-medium">No loads recorded.</div>';
        };

        window.calculateYield = () => {
            const sfInput = document.getElementById('input-sf'); if(!sfInput) return;
            const sf = parseFloat(sfInput.value) || 0;
            const inches = parseFloat(window.state.inches) || 0;
            const theo = (sf / 159) * inches;
            const rec = window.state.loads.reduce((sum, l) => sum + l.tons, 0);
            const updateText = (id, val) => { const el = document.getElementById(id); if(el) el.innerText = val; };
            updateText('display-theoretical', theo.toFixed(1));
            const badge = document.getElementById('yield-badge');
            const card = document.getElementById('yield-card');
            if(!badge || !card) return;
            if (sf === 0 || rec === 0) { badge.innerText="READY"; badge.className="px-2 py-1 rounded text-[10px] font-black bg-slate-800 uppercase text-slate-500 border border-yellow-400/10"; card.classList.remove('heavy-glow'); return; }
            const v = rec / (theo || 1);
            if (v > 1.05) { badge.innerText="HEAVY"; badge.className="px-2 py-1 rounded text-[10px] font-black bg-red-600 uppercase text-white"; card.classList.add('heavy-glow'); }
            else if (v < 0.95) { badge.innerText="LIGHT"; badge.className="px-2 py-1 rounded text-[10px] font-black bg-yellow-400 uppercase text-black"; card.classList.remove('heavy-glow'); }
            else { badge.innerText="ON TARGET"; badge.className="px-2 py-1 rounded text-[10px] font-black bg-green-500 uppercase text-white"; card.classList.remove('heavy-glow'); }
        };

        window.calculateLogistics = () => {
            const s = window.state; const now = new Date();
            const [hours, mins] = (s.plantClosing || "15:30").split(':');
            const closeDate = new Date(); closeDate.setHours(hours, mins, 0);
            const cutoffDate = new Date(closeDate.getTime() - (s.travelTimeReturn + 10) * 60000);
            const diffMins = Math.floor((cutoffDate - now) / 60000);
            const ctEl = document.getElementById('display-cutoff-time');
            const cdEl = document.getElementById('display-countdown');
            const cardEl = document.getElementById('cutoff-card');
            if (cdEl && cardEl) {
                if (diffMins < 0) {
                    cdEl.innerText = "CUTOFF EXCEEDED";
                    cdEl.className = "text-[10px] text-white font-black animate-pulse mt-1 uppercase";
                    cardEl.className = "bg-red-600 rounded-xl shadow-sm p-4 flex flex-col justify-between transition-all duration-500 text-white";
                    if(ctEl) { ctEl.innerText = cutoffDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); ctEl.className = "text-2xl font-black tabular-nums text-white"; }
                } else {
                    cdEl.innerText = `Exit site by ${cutoffDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
                    cdEl.className = "text-[10px] text-slate-500 font-black mt-1 uppercase text-black";
                    cardEl.className = "bg-white rounded-xl shadow-sm border p-4 flex flex-col justify-between transition-all duration-500 text-black";
                    if(ctEl) { ctEl.innerText = cutoffDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); ctEl.className = "text-2xl font-black tabular-nums text-slate-900"; }
                }
            }
            const cTimeDiff = Math.floor((closeDate - now) / 60000);
            const pBanner = document.getElementById('plant-close-banner');
            const pText = document.getElementById('plant-close-text');
            if (cTimeDiff <= 120 && cTimeDiff > 0 && !s.plantBannerDismissed) {
                const remaining = Math.max(0, s.totalGoal - (s.loads || []).reduce((sum, l) => sum + l.tons, 0)).toFixed(1);
                if(pBanner) pBanner.classList.remove('hidden');
                if(pText) pText.innerText = `${Math.floor(cTimeDiff/60)}h ${cTimeDiff%60}m till close. Contact plant with remaining ${remaining} tons.`;
            } else if (pBanner) { pBanner.classList.add('hidden'); }
        };

        // Secure Proxy Call
        async function callGemini(payload) {
            try {
                const response = await fetch(proxyUrl, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload) 
                });
                return await response.json();
            } catch (e) { 
                console.error(e); 
                window.showToast?.("AI Connection Error"); 
            }
        }

        window.findClosestPlant = async () => {
            const jaIn = document.getElementById('setup-job-address');
            if (!jaIn?.value) return window.showToast("Enter Job Address First");
            const btn = document.getElementById('plant-search-btn');
            if(btn) btn.classList.add('animate-pulse');
            try {
                window.state.jobAddress = jaIn.value;
                const payload = {
                    contents: [{ parts: [{ text: `Geocode address: '${jaIn.value}'. Return ONLY JSON: { "lat": number, "lng": number }.` }] }],
                    systemInstruction: { parts: [{ text: "Extract latitude and longitude." }] }
                };
                const result = await callGemini(payload);
                const match = result.candidates?.[0]?.content?.parts?.[0]?.text.match(/\{.*\}/s);
                const jobCoords = JSON.parse(match ? match[0] : "{}");
                if (jobCoords.lat) {
                    let closest = null; let minD = Infinity;
                    PLANT_DB.forEach(plant => {
                        const d = Math.sqrt(Math.pow(plant.lat - jobCoords.lat, 2) + Math.pow(plant.lng - jobCoords.lng, 2));
                        if (d < minD) { minD = d; closest = plant; }
                    });
                    if (closest) {
                        window.state.plantName = closest.name;
                        window.state.plantAddress = closest.addr;
                        window.state.salesRep = closest.rep;
                        window.state.salesRepPhone = closest.phone;
                        await window.saveToCloud();
                        window.updateUI();
                        window.showToast(`Located: ${closest.name}`);
                    }
                }
            } catch (e) { window.showToast("Plant Search Failed"); } finally { if(btn) btn.classList.remove('animate-pulse'); }
        };

        window.updateLiveTraffic = async (isAuto = false) => {
            const j = window.state.jobAddress; const p = window.state.plantAddress;
            if (!j || !p) return;
            if (!isAuto) window.showToast("Updating Traffic...");
            try {
                const payload = {
                    contents: [{ parts: [{ text: `Super10 dump truck traffic estimate. Route1: '${p}' to '${j}'. Route2: '${j}' to '${p}'. JSON ONLY: { "forward_mins": num, "return_mins": num, "incident": "str or null" }.` }] }],
                    tools: [{ "google_search": {} }],
                    systemInstruction: { parts: [{ text: "Provide traffic data in JSON format only." }] }
                };
                const result = await callGemini(payload);
                const match = result.candidates?.[0]?.content?.parts?.[0]?.text.match(/\{.*\}/s);
                const data = JSON.parse(match ? match[0] : "{}");
                if (data.forward_mins) {
                    const s = window.state;
                    if (!s.baselineForward) s.baselineForward = data.forward_mins;
                    if (!s.baselineReturn) s.baselineReturn = data.return_mins;
                    s.travelTimeForward = data.forward_mins;
                    s.travelTimeReturn = data.return_mins;
                    s.trafficIncident = data.incident;
                    window.saveToCloud(); window.updateUI();
                }
            } catch (e) { console.error(e); }
        };

        window.handleImageUpload = async (event) => {
            const file = event.target.files[0]; if (!file) return;
            window.showToast("Analyzing Ticket...");
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = async () => {
                const base64 = reader.result.split(',')[1];
                try {
                    const payload = {
                        contents: [{ parts: [{ text: "Extract: Net Tons, Truck ID." }, { inlineData: { mimeType: "image/png", data: base64 } }] }],
                        systemInstruction: { parts: [{ text: "JSON ONLY: { 'tons': number, 'truckId': string }" }] }
                    };
                    const result = await callGemini(payload);
                    const match = result.candidates?.[0]?.content?.parts?.[0]?.text.match(/\{.*\}/s);
                    const data = JSON.parse(match ? match[0] : "{}");
                    if (data.tons) {
                        window.state.loads.unshift({ id: Date.now(), tons: parseFloat(data.tons), truckId: String(data.truckId || "UNKNOWN").toUpperCase(), time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) });
                        window.saveToCloud(); window.showToast(`Logged ${data.tons}t`);
                    }
                } catch (e) { window.showToast("Scan Failed"); }
            };
        };

        window.autoCalculateTonsAndLoads = () => {
            const sf = parseFloat(document.getElementById('setup-job-sf').value);
            const depth = parseFloat(document.getElementById('setup-depth').value);
            if (!isNaN(sf) && !isNaN(depth) && sf > 0 && depth > 0) {
                const tons = (sf / 159) * depth;
                const loads = Math.ceil(tons / 18);
                const tonsEl = document.getElementById('setup-total-tons');
                const loadsEl = document.getElementById('setup-planned-loads');
                if(tonsEl) tonsEl.value = tons.toFixed(1);
                if(loadsEl) loadsEl.value = loads;
            }
        };

        window.handlePlantSelect = (name) => {
            const plant = PLANT_DB.find(p => p.name === name);
            if(plant) {
                document.getElementById('setup-plant-address').value = plant.addr;
                document.getElementById('setup-sales-rep').value = plant.rep;
                document.getElementById('setup-sales-phone').value = plant.phone;
            }
        };

        window.triggerScanner = () => { document.getElementById('ticket-file').click(); };
        window.addLoad = () => {
            const tonsIn = document.getElementById('new-load-tons'); const truckIn = document.getElementById('new-load-truck');
            const t = parseFloat(tonsIn?.value); if (!t) return window.showToast("Enter Tonnage");
            window.state.loads.unshift({ id: Date.now(), tons: t, truckId: truckIn?.value || "Manual", time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) });
            if(tonsIn) tonsIn.value = ''; window.saveToCloud(); window.showToast("Logged");
        };
        window.addTruck = () => {
            const id = document.getElementById('fleet-id')?.value.trim().toUpperCase(); if (!id) return window.showToast("ID Required");
            window.state.fleet.push({ id, driver: document.getElementById('fleet-driver')?.value.trim(), phone: document.getElementById('fleet-phone')?.value.trim() });
            const fid = document.getElementById('fleet-id'); if(fid) fid.value = '';
            window.saveToCloud(); window.renderFleet(); window.showToast("Unit Added");
        };
        window.renderFleet = () => {
            const list = document.getElementById('fleet-list'); if(!list) return;
            const truckSelect = document.getElementById('new-load-truck');
            if(truckSelect) truckSelect.innerHTML = '<option value="Manual">Unit #</option>' + window.state.fleet.map(t => `<option value="${t.id}">${t.id}</option>`).join('');
            list.innerHTML = window.state.fleet.map((t, idx) => `
                <div class="bg-white p-4 rounded-xl border-l-4 border-yellow-400 shadow-sm flex flex-col space-y-3">
                    <div class="flex justify-between items-start text-black">
                        <div><p class="text-[10px] font-black text-slate-400 uppercase tracking-widest leading-none mb-1 opacity-30 text-black">Unit #</p><p class="font-black text-xl text-black">${t.id}</p></div>
                        <div class="flex items-center space-x-2">
                            ${t.phone ? `<a href="tel:${t.phone.replace(/[^0-9]/g, '')}" class="bg-black text-yellow-400 p-2 rounded-full shadow-lg active:bg-yellow-400 active:text-black text-yellow-400 text-center"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 256 256"><path d="M222.37,158.46l-47.11-21.11-.13-.06a16,16,0,0,0-15.17,1.4,8.12,8.12,0,0,0-.75.56L143.16,155.3c-23.51-12.82-41.69-31-54.51-54.51l16.05-16.05a8.12,8.12,0,0,0,.56-.75,16,16,0,0,0,1.34-15.3l-.06-.13L85.44,41.43a16,16,0,0,0-18.42-9.28L35,39.69a16,16,0,0,0-12.44,14c-1.56,22.25,2.4,59.3,27.1,95s72.71,114.65,138.81,114.65l6.53,0a16,16,0,0,0,14.07-12.44l7.54-32A16,16,0,0,0,222.37,158.46Z"></path></svg></a>` : ''}
                            <button onclick="removeTruck('${t.id}')" class="text-slate-200 p-2 hover:text-red-500 font-bold text-black">X</button>
                        </div>
                    </div>
                </div>`).join('') || '<p class="p-8 text-center text-slate-400 italic font-bold">Add units or scan a ticket.</p>';
        };
        window.removeLoad = (id) => { window.state.loads = window.state.loads.filter(l => l.id !== id); window.saveToCloud(); };
        window.removeTruck = (id) => { if(confirm(`Remove truck ${id}?`)) { window.state.fleet = window.state.fleet.filter(t => t.id !== id); window.saveToCloud(); window.renderFleet(); } };
        window.clearHistory = () => { if(confirm("Permanently erase all load records?")) { window.state.loads = []; window.saveToCloud(); } };
        
        window.generateReport = () => {
            const s = window.state; const rec = s.loads.reduce((sum, l) => sum + l.tons, 0);
            const sfI = document.getElementById('input-sf'); const sf = sfI ? (parseFloat(sfI.value) || 0) : 0;
            const theo = (sf / 159) * (parseFloat(s.inches) || 0);
            const v = sf > 0 ? ((rec / (theo || 1)) * 100 - 100).toFixed(1) : 0;
            document.getElementById('report-date').innerText = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('report-job-title').innerText = (s.jobPo ? s.jobPo + " - " : "") + (s.jobAddress || "DAILY LOG");
            document.getElementById('report-received-val').innerText = rec.toFixed(1) + " t";
            document.getElementById('report-depth').innerText = (s.inches || 0) + '"';
            document.getElementById('report-yield').innerText = (v > 0 ? "+" : "") + v + "%";
            const rB = document.getElementById('report-table-body');
            if(rB) rB.innerHTML = s.loads.map((l, i) => `<tr><td class="p-4 border text-black">${s.loads.length - i}</td><td class="p-4 border text-center font-bold text-black">${l.time}</td><td class="p-4 border font-black uppercase text-center text-black">${l.truckId}</td><td class="p-4 border text-right font-black text-black">${l.tons.toFixed(2)}</td></tr>`).join('');
            document.getElementById('main-app-container').classList.add('hidden');
            const rv = document.getElementById('report-view'); if(rv) { rv.classList.remove('hidden'); rv.classList.remove('print-only'); }
            window.scrollTo(0,0);
        };
        window.closeReport = () => { 
            const main = document.getElementById('main-app-container'); if(main) main.classList.remove('hidden');
            const rv = document.getElementById('report-view'); if(rv) { rv.classList.add('hidden'); rv.classList.add('print-only'); }
        };
        window.saveSetup = () => {
            const s = window.state;
            s.jobAddress = document.getElementById('setup-job-address').value;
            s.jobPo = document.getElementById('setup-job-po').value;
            s.jobSf = document.getElementById('setup-job-sf').value;
            s.plantName = document.getElementById('setup-plant-name').value;
            s.plantAddress = document.getElementById('setup-plant-address').value;
            s.salesRep = document.getElementById('setup-sales-rep').value;
            s.salesRepPhone = document.getElementById('setup-sales-phone').value;
            s.totalGoal = parseFloat(document.getElementById('setup-total-tons').value) || 0;
            s.plannedLoads = parseInt(document.getElementById('setup-planned-loads').value) || 0;
            s.inches = parseFloat(document.getElementById('setup-depth').value) || 0;
            s.plantClosing = document.getElementById('setup-plant-close').value;
            s.plantBannerDismissed = false; 
            window.saveToCloud(); window.updateLiveTraffic(); window.showToast("Settings Saved"); window.switchTab('dashboard');
        };
        window.dismissPlantBanner = () => { window.state.plantBannerDismissed = true; window.saveToCloud(); if(document.getElementById('plant-close-banner')) document.getElementById('plant-close-banner').classList.add('hidden'); };
    </script>
</body>

</html>
