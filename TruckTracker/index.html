<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TruckTracker | Paving Logistics & Yield</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap');
    body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; padding-bottom: 110px; }
    .progress-bar { transition: width 0.5s ease-in-out; }
    .heavy-glow { box-shadow: 0 0 25px rgba(239, 68, 68, 0.6); border-color: #ef4444 !important; }

    @keyframes pulse-red-border { 0% { border-color: #ef4444; box-shadow: 0 0 0px rgba(239,68,68,0); } 50% { border-color: #ef4444; box-shadow: 0 0 15px rgba(239,68,68,0.5); } 100% { border-color: #ef4444; box-shadow: 0 0 0px rgba(239,68,68,0); } }
    .pulse-border { animation: pulse-red-border 2s infinite; border: 2px solid #ef4444 !important; }

    @keyframes pulse-red { 0%, 100% { background-color: #991b1b; } 50% { background-color: #ef4444; } }
    @keyframes pulse-warning { 0%, 100% { background-color: #facc15; } 50% { background-color: #eab308; } }
    .emergency-banner { animation: pulse-red 2s infinite; }
    .warning-banner { animation: pulse-warning 3s infinite; }
    @media print { .no-print { display: none !important; } .print-only { display: block !important; } body { background: white; padding-bottom: 0; } }
    .tab-active { color: #facc15 !important; }
    .tab-active svg { fill: #facc15 !important; }
    input:focus, select:focus { outline: none; border-color: #facc15; ring: 2px #facc15; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900 min-h-screen font-medium">

  <!-- TOAST -->
  <div id="toast"
       class="fixed top-4 left-1/2 -translate-x-1/2 z-[9999] bg-black text-yellow-400 px-4 py-2 rounded-xl font-black uppercase tracking-widest text-[10px] shadow-2xl opacity-0 transition-opacity duration-300">
    Ready
  </div>

  <!-- AUTHENTICATION VIEW -->
  <div id="view-auth" class="min-h-screen flex items-center justify-center p-6 bg-slate-900">
    <div class="w-full max-w-sm bg-white rounded-3xl shadow-2xl overflow-hidden border-b-8 border-yellow-400">
      <div class="bg-black p-8 text-center text-white">
        <h1 class="text-3xl font-black tracking-tighter italic text-yellow-400 uppercase leading-none mb-2">TruckTracker</h1>
        <p class="text-[10px] text-slate-400 uppercase font-black tracking-[0.2em]">Logistics Management</p>
      </div>
      <div class="p-8 space-y-4">
        <div class="space-y-1">
          <label class="text-[10px] font-black uppercase text-slate-400 px-1">Email Address</label>
          <input type="email" id="auth-email" class="w-full border-2 border-slate-100 p-3 rounded-xl font-bold focus:border-yellow-400 transition-colors" placeholder="name@company.com">
        </div>
        <div class="space-y-1">
          <label class="text-[10px] font-black uppercase text-slate-400 px-1">Password</label>
          <input type="password" id="auth-pass" class="w-full border-2 border-slate-100 p-3 rounded-xl font-bold focus:border-yellow-400 transition-colors" placeholder="••••••••">
        </div>
        <div class="pt-4 flex flex-col space-y-3">
          <button onclick="handleAuth('login')" class="w-full bg-black text-yellow-400 py-4 rounded-2xl font-black uppercase tracking-widest shadow-lg active:scale-95 transition-transform">
            Sign In
          </button>
          <button onclick="handleAuth('signup')" class="w-full text-slate-400 py-2 font-bold text-xs uppercase tracking-widest hover:text-black transition-colors text-center">
            Create New Account
          </button>
          <p class="text-[10px] text-slate-400 leading-snug pt-2">
            If you see <span class="font-black">auth/operation-not-allowed</span>, enable
            <span class="font-black">Authentication → Sign-in method → Email/Password</span> in Firebase Console.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- APP WRAPPER (used by report show/hide) -->
  <div id="app" class="no-print">

    <!-- MAIN APP CONTAINER -->
    <div id="main-app-container" class="hidden max-w-xl mx-auto">
      <header class="bg-black text-white p-4 sticky top-0 z-50 shadow-lg border-b border-yellow-400/30">
        <div class="flex justify-between items-center text-center">
          <div class="flex-1 text-center text-white">
            <h1 class="text-xl font-black tracking-tighter italic text-yellow-400 uppercase leading-none"
                style="filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5)); text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">
              TruckTracker
            </h1>
            <p id="header-job-name" class="text-[10px] text-slate-400 uppercase font-black tracking-[0.15em] mt-1 truncate max-w-[250px] mx-auto"></p>
          </div>
        </div>
      </header>

      <div id="traffic-delay-banner" class="hidden emergency-banner text-white p-3 flex items-center justify-between shadow-lg">
        <div class="flex items-center space-x-3 text-white">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="white" viewBox="0 0 256 256" class="animate-bounce">
            <path d="M236.8,188.09,149.35,36.22a24.76,24.76,0,0,0-42.7,0L19.2,188.09a23.51,23.51,0,0,0,0,23.72A24.34,24.34,0,0,0,40.55,224h174.9a24.34,24.34,0,0,0,21.35-12.19A23.51,23.51,0,0,0,236.8,188.09ZM120,104a8,8,0,0,1,16,0v40a8,8,0,0,1-16,0Zm8,88a12,12,0,1,1,12-12A12,12,0,0,1,128,192Z"></path>
          </svg>
          <div>
            <p class="text-xs font-black uppercase tracking-tighter leading-none mb-1">SIGNIFICANT DELAY</p>
            <p id="traffic-delay-text" class="text-[10px] font-bold opacity-90"></p>
          </div>
        </div>
        <button onclick="document.getElementById('traffic-delay-banner').classList.add('hidden')" class="bg-black/20 p-1 rounded font-bold text-white">X</button>
      </div>

      <div id="plant-close-banner" class="hidden warning-banner bg-yellow-400 text-black p-3 flex items-center shadow-lg border-b border-yellow-600/20">
        <div class="flex items-center space-x-3 w-full">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256">
            <path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm64-88a8,8,0,0,1-8,8H128a8,8,0,0,1-8-8V72a8,8,0,0,1,16,0v40h48A8,8,0,0,1,192,128Z"></path>
          </svg>
          <div class="flex-1">
            <p class="text-[10px] font-black uppercase tracking-tight leading-none mb-1 text-black">Plant Closing Imminent</p>
            <p id="plant-close-text" class="text-xs font-bold leading-tight text-black"></p>
          </div>
          <button onclick="dismissPlantBanner()" class="bg-black/10 px-2 py-1 rounded font-black text-xs">HIDE</button>
        </div>
      </div>

      <main id="view-dashboard" class="p-4 space-y-6">
        <div class="bg-white rounded-2xl p-5 shadow-sm border border-slate-200 flex items-center justify-between text-black">
          <div class="flex items-center space-x-4 overflow-hidden">
            <div class="bg-yellow-400 p-3 rounded-2xl text-black shrink-0">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256">
                <path d="M248,112h-8V104a16,16,0,0,0-16-16h-4.2l-14.8-44.4A15.9,15.9,0,0,0,190,32H66a15.9,15.9,0,0,0-15,11.6L36.2,88H32a16,16,0,0,0-16,16v8H8a8,8,0,0,0,0,16H16v88a16,16,0,0,0,16,16H224a16,16,0,0,0,16-16V128h8a8,8,0,0,0,0-16ZM66,48H190l13.33,40H52.67ZM224,216H32V104H224V216ZM128,144a16,16,0,1,1-16,16A16,16,0,0,1,128,144Z"></path>
              </svg>
            </div>
            <div class="overflow-hidden">
              <p id="display-plant-name" class="font-black text-black leading-none text-sm uppercase truncate">No Plant Selected</p>
              <p id="display-sales-rep" class="text-slate-400 font-bold text-[10px] uppercase mt-1 tracking-wider truncate">No Sales Rep Set</p>
            </div>
          </div>
          <a id="sales-rep-call-btn" href="tel:" onclick="dismissPlantBanner()" class="bg-black text-yellow-400 p-3 rounded-2xl shadow-lg active:scale-90 transition-transform shrink-0 hidden">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256">
              <path d="M222.37,158.46l-47.11-21.11-.13-.06a16,16,0,0,0-15.17,1.4,8.12,8.12,0,0,0-.75.56L143.16,155.3c-23.51-12.82-41.69-31-54.51-54.51l16.05-16.05a8.12,8.12,0,0,0,.56-.75,16,16,0,0,0,1.34-15.3l-.06-.13L85.44,41.43a16,16,0,0,0-18.42-9.28L35,39.69a16,16,0,0,0-12.44,14c-1.56,22.25,2.4,59.3,27.1,95s72.71,114.65,138.81,114.65l6.53,0a16,16,0,0,0,14.07-12.44l7.54-32A16,16,0,0,0,222.37,158.46Z"></path>
            </svg>
          </a>
        </div>

        <!-- Cycle Times Widget -->
        <div id="travel-widget" class="bg-white rounded-2xl shadow-xl border-2 border-slate-200 overflow-hidden ring-4 ring-slate-100 transition-all duration-500">
          <div class="bg-slate-900 px-4 py-2 border-b-4 border-yellow-400 flex justify-between items-center text-white">
            <div>
              <h3 class="font-black text-xs text-white uppercase tracking-tighter italic">Truck Cycle Times</h3>
              <p class="text-[8px] text-yellow-400/70 font-black uppercase tracking-widest leading-none">Super10 Dynamics</p>
            </div>
            <button onclick="updateLiveTraffic()" class="bg-yellow-400 text-black px-2 py-1 rounded text-[9px] font-black uppercase shadow-sm hover:bg-yellow-300 transition-colors">
              Refresh
            </button>
          </div>
          <div class="p-4 grid grid-cols-2 gap-3 bg-slate-50/50">
            <div class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm flex flex-col items-center text-center text-black">
              <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Hotplant → Jobsite</p>
              <p id="travel-forward" class="text-3xl font-black text-slate-900 tabular-nums">-- <span class="text-xs text-slate-400 font-bold uppercase tracking-tighter">m</span></p>
            </div>
            <div class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm flex flex-col items-center text-center text-black">
              <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Jobsite → Hotplant</p>
              <p id="travel-return" class="text-3xl font-black text-slate-900 tabular-nums">-- <span class="text-xs text-slate-400 font-bold uppercase tracking-tighter">m</span></p>
            </div>
          </div>
        </div>

        <!-- MAIN DATA TALLY -->
        <div class="bg-black text-white rounded-2xl shadow-2xl p-6 relative overflow-hidden border-b-4 border-yellow-400">
          <div class="relative z-10 text-white">
            <div class="flex justify-between items-end mb-4">
              <div>
                <p class="text-[10px] font-black uppercase tracking-[0.2em] text-yellow-400 mb-1 opacity-60">Tons Received</p>
                <h2 class="text-7xl font-black tabular-nums tracking-tighter leading-none text-yellow-400" id="display-received">0.0</h2>
              </div>
              <div class="text-right pb-1">
                <p class="text-[10px] font-black uppercase tracking-[0.2em] text-white mb-1 leading-none opacity-60">Truck Count</p>
                <h2 class="text-2xl font-black text-white leading-none opacity-40">
                  <span id="display-loads-count">0</span><span class="text-sm mx-0.5">/</span><span id="display-loads-goal">--</span>
                </h2>
              </div>
            </div>
            <div class="w-full bg-slate-900 h-4 rounded-full overflow-hidden mb-3 border border-slate-800">
              <div id="progress-bar" class="progress-bar bg-yellow-400 h-full"></div>
            </div>
            <div class="flex justify-between text-[10px] font-black text-slate-500 uppercase tracking-widest">
              <span>Goal Completion</span>
              <span>Remaining: <span id="display-remaining" class="text-yellow-400">0</span> t</span>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3 text-black">
          <div class="bg-white rounded-xl shadow-sm border p-4 flex flex-col justify-between">
            <p class="text-xs font-black text-slate-400 uppercase tracking-tight">Live Avg Truck</p>
            <div class="flex items-baseline space-x-1">
              <span class="text-3xl font-black text-slate-900" id="display-avg-size">18.0</span>
              <span class="text-[10px] text-slate-400 font-bold uppercase tracking-tighter">tons</span>
            </div>
          </div>
          <div class="bg-white rounded-xl shadow-sm border p-4 flex flex-col justify-between transition-all duration-500" id="cutoff-card">
            <div class="flex justify-between items-start">
              <p id="cutoff-title" class="text-xs font-black text-slate-400 uppercase tracking-tight">Last Truck Out</p>
            </div>
            <span class="text-2xl font-black tabular-nums text-slate-900" id="display-cutoff-time">--:--</span>
            <p id="display-countdown" class="text-[10px] text-slate-500 font-black uppercase mt-1 leading-none tracking-tighter italic">Calculating...</p>
          </div>
        </div>

        <!-- Yield Guard -->
        <div class="bg-black rounded-2xl shadow-xl p-5 border-2 border-transparent transition-all duration-500 text-white" id="yield-card">
          <div class="flex justify-between items-center mb-4 text-white">
            <h3 class="font-bold text-xs uppercase tracking-[0.2em] text-slate-500">Yield Guard</h3>
            <div id="yield-badge" class="px-2 py-1 rounded text-[10px] font-black uppercase bg-slate-800 text-yellow-400 border border-yellow-400/20">Ready</div>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-[10px] uppercase font-black opacity-40 mb-1 text-white">SQ FT Paved</label>
              <input type="number" id="input-sf" placeholder="Enter SF" oninput="calculateYield()" class="w-full bg-slate-900 border-slate-800 border p-3 rounded-xl text-2xl font-black text-yellow-400 focus:ring-2 focus:ring-yellow-400">
            </div>
            <div class="flex flex-col justify-center">
              <p class="text-[10px] uppercase font-black opacity-40 mb-1 leading-none text-slate-400">Theo. Needed</p>
              <p class="text-3xl font-black text-yellow-400" id="display-theoretical">0.0</p>
            </div>
          </div>
        </div>

        <!-- Detailed History -->
        <div class="bg-white rounded-2xl shadow-xl border-2 border-slate-200 overflow-hidden ring-4 ring-slate-100">
          <div class="bg-slate-900 p-4 border-b-4 border-yellow-400 flex justify-between items-center text-white">
            <div>
              <h3 class="font-black text-xl text-white uppercase tracking-tighter italic">Detailed History</h3>
              <p class="text-[9px] text-yellow-400/70 font-black uppercase tracking-widest leading-none mt-1">Live Material Log</p>
            </div>
            <button onclick="clearHistory()" class="bg-red-600 text-white hover:bg-red-700 px-3 py-1.5 rounded-lg text-[10px] font-black uppercase transition-all shadow-sm">Clear Log</button>
          </div>

          <div class="bg-slate-50 p-5 border-b-2 border-slate-200 shadow-inner">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4 text-center">New Arrival Intake</p>
            <div class="space-y-4">
              <div class="grid grid-cols-2 gap-3 text-black">
                <div class="space-y-1">
                  <label class="text-[9px] font-black text-slate-400 uppercase px-1">Net Tonnage</label>
                  <input type="number" id="new-load-tons" placeholder="0.00" step="0.01" class="w-full border-2 border-slate-200 p-3 rounded-xl text-xl font-black bg-white focus:border-yellow-400 transition-colors">
                </div>
                <div class="space-y-1">
                  <label class="text-[9px] font-black text-slate-400 uppercase px-1">Assign Truck</label>
                  <select id="new-load-truck" class="w-full border-2 border-slate-200 p-3 rounded-xl text-sm font-bold bg-white focus:border-yellow-400 transition-colors h-[52px]"></select>
                </div>
              </div>

              <button onclick="triggerScanner()" id="scanner-btn" class="w-full flex items-center justify-center space-x-3 bg-black text-yellow-400 py-4 rounded-xl font-black uppercase tracking-widest shadow-lg active:scale-[0.98] transition-all border border-yellow-400/20">
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 256 256">
                  <path d="M208,56H180.28L166.65,35.56A8,8,0,0,0,160,32H96a8,8,0,0,0-6.65,3.56L75.72,56H48A24,24,0,0,0,24,80V192a24,24,0,0,0,24,24H208a24,24,0,0,0,24-24V80A24,24,0,0,0,208,56Zm8,136a8,8,0,0,1-8,8H48a8,8,0,0,1-8-8V80a8,8,0,1,1,8-8H80a8,8,0,0,0,6.65-3.56L100.28,48h55.44l13.63,20.44A8,8,0,0,0,176,72h32a8,8,0,0,1,8,8ZM128,88a44,44,0,1,0,44,44A44.05,44.05,0,0,0,128,88Zm0,72a28,28,0,1,1,28-28A28,28,0,0,1,128,160Z"></path>
                </svg>
                <span id="scanner-text">Scan Weigh Ticket</span>
              </button>

              <button onclick="addLoad()" class="w-full bg-white border-2 border-slate-200 py-2.5 rounded-xl text-slate-500 font-black uppercase text-[10px] tracking-widest hover:bg-slate-100 transition-colors">
                Log Manual Entry
              </button>

              <input type="file" id="ticket-file" accept="image/*" capture="environment" class="hidden" onchange="handleImageUpload(event)">
            </div>
          </div>

          <div id="load-list" class="divide-y divide-slate-100 max-h-[450px] overflow-y-auto bg-white text-black"></div>
        </div>
      </main>

      <!-- FLEET TAB -->
      <main id="view-fleet" class="hidden p-4 space-y-4">
        <div class="bg-white rounded-2xl shadow-sm border p-4 text-black">
          <h3 class="font-black text-xs text-slate-400 mb-3 text-center uppercase tracking-widest">Unit Registration</h3>
          <div class="space-y-3">
            <div class="grid grid-cols-2 gap-2 text-black">
              <input type="text" id="fleet-id" placeholder="Unit #" class="border p-3 rounded-xl font-bold bg-slate-50 uppercase text-black">
              <input type="text" id="fleet-driver" placeholder="Driver" class="border p-3 rounded-xl font-bold bg-slate-50 text-black">
            </div>
            <input type="tel" id="fleet-phone" placeholder="Cell Number" class="w-full border p-3 rounded-xl font-bold bg-slate-50 text-black">
            <button onclick="addTruck()" class="w-full bg-black text-yellow-400 py-3 rounded-xl font-black uppercase tracking-widest border border-yellow-400/20 shadow-md">
              Add Truck
            </button>
          </div>
        </div>
        <div id="fleet-list" class="space-y-3 pb-8 text-black"></div>
      </main>

      <!-- CONFIG TAB -->
      <main id="view-settings" class="hidden p-4 space-y-4 text-black">
        <div class="bg-white rounded-2xl shadow-sm border p-6">
          <h2 class="text-sm font-black uppercase text-slate-500 mb-6 tracking-widest text-center border-b pb-2">Project Configuration</h2>
          <div class="space-y-4">

            <div class="space-y-1">
              <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest">Project Details</label>
              <input type="text" id="setup-job-po" placeholder="Job/PO #" class="w-full border p-3 rounded-xl bg-slate-50 font-bold mb-2">
              <div class="flex space-x-1">
                <input type="text" id="setup-job-address" placeholder="Job Street Address" class="flex-1 border p-3 rounded-xl bg-slate-50 font-bold">
                <button onclick="findClosestPlant()" id="plant-search-btn" class="bg-black text-yellow-400 px-4 rounded-xl font-bold border border-yellow-400/20 active:bg-yellow-400 active:text-black shadow-md">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256"><path d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z"></path></svg>
                </button>
              </div>
            </div>

            <div class="bg-slate-50 p-4 rounded-2xl border border-slate-200">
              <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Paving Requirements</label>
              <div class="grid grid-cols-2 gap-3 mb-3 text-black">
                <div>
                  <label class="block text-[9px] font-bold text-slate-400 uppercase">Est. SQ FT</label>
                  <input type="number" id="setup-job-sf" placeholder="Enter SF" oninput="autoCalculateTonsAndLoads()" class="w-full border p-3 rounded-xl bg-white font-bold text-black">
                </div>
                <div>
                  <label class="block text-[9px] font-bold text-slate-400 uppercase">Mat Depth (IN)</label>
                  <input type="number" id="setup-depth" placeholder="Depth" oninput="autoCalculateTonsAndLoads()" class="w-full border p-3 rounded-xl bg-white font-bold text-black">
                </div>
              </div>
              <div class="grid grid-cols-2 gap-3 text-black">
                <div>
                  <label class="block text-[9px] font-bold text-slate-400 uppercase">Tons Goal</label>
                  <input type="number" id="setup-total-tons" placeholder="Tons" class="w-full border p-3 rounded-xl bg-white font-bold text-black">
                </div>
                <div>
                  <label class="block text-[9px] font-bold text-slate-400 uppercase">Planned Loads</label>
                  <input type="number" id="setup-planned-loads" placeholder="Loads" class="w-full border p-3 rounded-xl bg-white font-bold text-black">
                </div>
              </div>
            </div>

            <div class="space-y-1">
              <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest text-black">Hotplant Selection</label>
              <select id="setup-plant-name" onchange="handlePlantSelect(this.value)" class="w-full border p-3 rounded-xl bg-white font-bold mb-2 text-black"></select>
              <input type="text" id="setup-plant-address" placeholder="Facility Address" class="w-full border p-3 rounded-xl bg-slate-50 font-bold mb-2 text-black">
              <div class="grid grid-cols-2 gap-2 text-black">
                <input type="text" id="setup-sales-rep" placeholder="Sales Rep" class="border p-3 rounded-xl bg-slate-50 font-bold text-black">
                <input type="tel" id="setup-sales-phone" placeholder="Rep Phone #" class="border p-3 rounded-xl bg-slate-50 font-bold text-black">
              </div>
            </div>

            <div class="grid grid-cols-1 gap-3">
              <div>
                <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest text-black">Plant Close</label>
                <input type="time" id="setup-plant-close" value="15:30" class="w-full border p-3 rounded-xl bg-slate-50 font-bold text-black">
              </div>
            </div>

            <div class="pt-6 border-t border-slate-100">
              <button onclick="handleSignOut()" class="w-full bg-slate-100 text-slate-400 py-3 rounded-xl font-bold uppercase text-[10px] tracking-widest hover:bg-red-50 hover:text-red-500 transition-all text-center">
                Sign Out Account
              </button>
            </div>

            <button onclick="saveSetup()" class="w-full bg-black text-yellow-400 py-4 rounded-2xl font-black uppercase tracking-widest shadow-lg border border-yellow-400/30 mt-4 active:scale-95 transition-transform">
              Save Parameters
            </button>

            <div class="pt-4 text-[10px] text-slate-400 leading-snug">
              <span class="font-black">Traffic + Scan:</span> If you want AI traffic/scan features, set
              <span class="font-black">window.GEMINI_API_KEY</span> in the console (or hardcode below) and enable billing/limits.
              Otherwise those buttons will simply show a message and do nothing.
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- BOTTOM NAVIGATION -->
    <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 bg-black border-t border-yellow-400/20 flex justify-around p-3 z-50 shadow-2xl hidden">
      <button onclick="switchTab('dashboard')" id="nav-dashboard" class="flex flex-col items-center p-2 tab-active transition-all">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256"><path d="M224,120v88a16,16,0,0,1-16,16H160a8,8,0,0,1-8-8V160H104v48a8,8,0,0,1-8,8H48a16,16,0,0,1-16-16V120a8,8,0,0,1,2.34-5.66l80-80a8,8,0,0,11.32,0l80,80A8,8,0,0,1,224,120Z"></path></svg>
        <span class="nav-label text-[9px] font-black mt-1 uppercase tracking-widest text-[#facc15]">Dashboard</span>
      </button>
      <button onclick="switchTab('fleet')" id="nav-fleet" class="flex flex-col items-center p-2 text-slate-500 transition-all">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256"><path d="M245.52,142.17l-14.45-50.58A24,24,0,0,0,208,72H48a24,24,0,0,0-23.07,19.59L10.48,142.17A23.9,23.9,0,0,0,8,152v48a16,16,0,0,0,16,16H232a16,16,0,0,0,16-16V152A23.9,23.9,0,0,0,245.52,142.17ZM48,88H208a8,8,0,1,1,7.69,5.8l13.72,48a8,8,0,0,1,.59,3L230,144.83,212.83,128H43.17L26,144.83,26,142.17l14.31-50.11A8,8,0,0,1,48,88ZM232,200H24V161.43l13.43-13.43a8,8,0,0,1,11.31,0L67.43,166.7a8,8,0,0,0,11.31,0l26.63-26.63a8,8,0,0,1,11.31,0L143.4,166.7a8,8,0,0,0,11.31,0l26.63-26.63a8,8,0,1,1,11.31,0l18.66,18.66,20.69,20.69V200ZM72,112a8,8,0,0,1-8,8H48a8,8,0,0,1,0-16H64A8,8,0,0,1,72,112Zm136,8a8,8,0,0,0,0-16H192a8,8,0,0,0,0,16Z"></path></svg>
        <span class="nav-label text-[9px] font-black mt-1 uppercase tracking-widest text-slate-400">Fleet</span>
      </button>
      <button onclick="switchTab('settings')" id="nav-settings" class="flex flex-col items-center p-2 text-slate-500 transition-all">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256"><path d="M236.46,147.21l-19.46-13.62a8,8,0,0,1-3.21-6.57V129a8,8,0,1,1,3.21-6.57l19.46-13.62a8,8,0,0,0,2.15-11.23L223.11,72.4a8,8,0,0,0-10.74-2.84l-20.89,11.41a8,8,0,0,1-8.52-.75,81.16,81.16,0,0,0-13.92-8.03,8,8,0,0,1-4.71-7.14l-2.48-23.63a8,8,0,0,0-8-7.16H120a8,8,0,0,0-8,7.16l-2.48,23.63a8,8,0,0,1-4.71,7.14,81.16,81.16,0,0,0-13.92,8.03,8,8,0,0,1-8.52,.75L61.48,69.56a8,8,0,0,0-10.74,2.84L35.25,97.58a8,8,0,0,0,2.15,11.23l19.46,13.62a8,8,0,0,1,3.21,6.57v2.02a8,8,0,0,1-3.21,6.57L37.4,151.21a8,8,0,0,0-2.15,11.23l15.49,25.18a8,8,0,0,0,10.74,2.84l20.89-11.41a8,8,0,0,1,8.52,.75,81.16,81.16,0,0,0,13.92-8.03,8,8,0,0,1,4.71,7.14l2.48,23.63a8,8,0,0,0,8,7.16h32.14a8,8,0,0,0,8-7.16l2.48-23.63a8,8,0,0,1,4.71-7.14,81.16,81.16,0,0,0,13.92,8.03,8,8,0,0,1,8.52-.75l20.89,11.41a8,8,0,0,0,10.74-2.84l15.49-25.18A8,8,0,0,0,236.46,147.21ZM128,156a28,28,0,1,1,28-28A28,28,0,0,1,128,156Z"></path></svg>
        <span class="nav-label text-[9px] font-black mt-1 uppercase tracking-widest text-slate-400">Config</span>
      </button>
      <button onclick="generateReport()" class="flex flex-col items-center p-2 text-slate-500 hover:text-yellow-400 transition-all">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256"><path d="M200,32H56A16,16,0,0,0,40,48V208a16,16,0,0,0,16,16H200a16,16,0,0,0,16-16V48A16,16,0,0,0,200,32Zm0,176H56V48H200V208ZM184,96a8,8,0,0,1-8,8H80a8,8,0,0,1,0-16h96A8,8,0,0,1,184,96Zm0,32a8,8,0,0,1-8,8H80a8,8,0,0,1,0-16h96A8,8,0,0,1,184,128Zm0,32a8,8,0,0,1-8,8H80a8,8,0,0,1,0-16h96A8,8,0,0,1,184,160Z"></path></svg>
        <span class="nav-label text-[9px] font-black mt-1 uppercase tracking-widest text-center text-slate-400">Run report</span>
      </button>
    </nav>
  </div>

  <!-- REPORT VIEW (print friendly) -->
  <div id="report-view" class="hidden print-only bg-white min-h-screen p-6">
    <div class="max-w-4xl mx-auto">
      <div class="flex items-start justify-between gap-4 mb-6">
        <div>
          <h1 class="text-3xl font-black tracking-tighter">TruckTracker Daily Log</h1>
          <p id="report-date" class="text-sm text-slate-500 font-bold mt-1"></p>
          <p id="report-job-title" class="text-sm font-black mt-2"></p>
        </div>
        <div class="no-print flex gap-2">
          <button onclick="window.print()" class="bg-black text-yellow-400 px-4 py-2 rounded-xl font-black uppercase tracking-widest text-[10px]">Print</button>
          <button onclick="closeReport()" class="bg-slate-100 text-slate-700 px-4 py-2 rounded-xl font-black uppercase tracking-widest text-[10px]">Back</button>
        </div>
      </div>

      <div class="grid grid-cols-3 gap-3 mb-6">
        <div class="border rounded-2xl p-4">
          <p class="text-[10px] uppercase tracking-widest text-slate-400 font-black">Total Received</p>
          <p id="report-received-val" class="text-2xl font-black mt-1">0.0 t</p>
        </div>
        <div class="border rounded-2xl p-4">
          <p class="text-[10px] uppercase tracking-widest text-slate-400 font-black">Depth</p>
          <p id="report-depth" class="text-2xl font-black mt-1">0"</p>
        </div>
        <div class="border rounded-2xl p-4">
          <p class="text-[10px] uppercase tracking-widest text-slate-400 font-black">Yield Variance</p>
          <p id="report-yield" class="text-2xl font-black mt-1">0%</p>
        </div>
      </div>

      <div class="overflow-x-auto border rounded-2xl">
        <table class="w-full text-sm">
          <thead class="bg-slate-50">
            <tr>
              <th class="p-3 text-left font-black uppercase tracking-widest text-[10px] text-slate-500">Load #</th>
              <th class="p-3 text-center font-black uppercase tracking-widest text-[10px] text-slate-500">Time</th>
              <th class="p-3 text-center font-black uppercase tracking-widest text-[10px] text-slate-500">Truck</th>
              <th class="p-3 text-right font-black uppercase tracking-widest text-[10px] text-slate-500">Tons</th>
            </tr>
          </thead>
          <tbody id="report-table-body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- MODULE SCRIPT -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // OPTIONAL: set in console: window.GEMINI_API_KEY = "YOUR_KEY";
    const GEMINI_API_KEY = (window.GEMINI_API_KEY || "").trim();

    // --- CONSTANTS & DATABASE ---
    const PLANT_DB = [
      { lng: -118.4033884, lat: 37.41938687, name: "Granite: Bishop Facility", rep: "Angela McAbee", phone: "(661) 331-3215", addr: "5 Bridges Road, Bishop, CA. 93514" },
      { lng: -121.880199, lat: 37.57599303, name: "Martin Marietta: Sunol", rep: "Mark Weiler", phone: "(925) 519-6828", addr: "7999 Athenour Way, Sunol CA 94586" },
      { lng: -121.860825, lat: 38.01463303, name: "Antioch Building Materials: Antioch", rep: "Niels Larsen", phone: "(510) 382-0119", addr: "Antioch, CA" },
      { lng: -122.061823, lat: 38.00167903, name: "County Quarry: Concord", rep: "Chris Gray", phone: "(925) 383-7464", addr: "5501 Imhoff Drive, Martinez CA 94553" },
      { lng: -122.72286, lat: 38.38536203, name: "Vulcan: Todd Road Plant", rep: "Cori Selke", phone: "(707) 302-9247", addr: "Todd Road, Santa Rosa, CA" },
      { lng: -122.45297, lat: 37.98642203, name: "Dutra Group: San Rafael", rep: "Sales", phone: "(415) 459-7740", addr: "2350 Kerner Blvd., San Rafael, CA 94901" },
      { lng: -122.393506, lat: 37.89249703, name: "Dutra Group: Richmond", rep: "Sales", phone: "(415) 459-7740", addr: "Richmond, CA" },
      { lng: -122.253401, lat: 38.21980603, name: "Vulcan: Napa Green Island", rep: "Cori Selke", phone: "(707) 302-9247", addr: "1000 Green Island Rd, American Canyon, CA 94503" },
      { lng: -122.180765, lat: 38.11062003, name: "Vulcan: Vallejo Lake Herman", rep: "Cori Selke", phone: "(707) 302-9247", addr: "885 Lake Herman Road, Vallejo, CA 94591" },
      { lng: -122.043697, lat: 37.62534503, name: "Vulcan: Hayward Facility", rep: "Niels Larsen", phone: "(510) 382-0119", addr: "Hayward, CA" },
      { lng: -121.886361, lat: 37.338208, name: "Vulcan: San Jose Facility", rep: "Niels Larsen", phone: "(510) 382-0119", addr: "San Jose, CA" },
      { lng: -121.3654, lat: 38.5234, name: "Granite: Sacramento Facility", rep: "Mark Weiler", phone: "(925) 519-6828", addr: "8675 Kiefer Blvd, Sacramento, CA 95826" }
    ].sort((a, b) => a.name.localeCompare(b.name));

    // --- FIREBASE CONFIG ---
    let firebaseConfig;
    if (typeof __firebase_config !== "undefined") {
      firebaseConfig = JSON.parse(__firebase_config);
    } else {
      firebaseConfig = {
        apiKey: "AIzaSyBYSkFXUCVrRbWR_x2vKlETnB-bTaPitpQ",
        authDomain: "trucktracker-90dad.firebaseapp.com",
        projectId: "trucktracker-90dad",
        storageBucket: "trucktracker-90dad.firebasestorage.app",
        messagingSenderId: "437299264555",
        appId: "1:437299264555:web:f21f05ad0b5c031a28be6e",
        measurementId: "G-MYJQ26Z2KF"
      };
    }

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // If you're running inside Firebase "App Hosting preview" / artifacts environment:
    const activeAppId = (typeof __app_id !== "undefined" ? __app_id : "trucktracker-production");

    let user = null;

    window.state = {
      jobPo: "", jobAddress: "", jobSf: "",
      plantName: "No Plant Selected", plantAddress: "", plantPhone: "",
      salesRep: "Unassigned", salesRepPhone: "",
      totalGoal: 0, plannedLoads: 0, inches: 0,
      plantClosing: "15:30", travelTimeForward: 0, travelTimeReturn: 0,
      baselineForward: 0, baselineReturn: 0,
      loads: [], fleet: [], avgTruckSize: 18.0,
      trafficIncident: null, activeTab: "dashboard",
      plantBannerDismissed: false
    };

    // --- UTILITIES ---
    window.showToast = (m) => {
      const t = document.getElementById('toast');
      if (!t) return;
      t.innerText = String(m);
      t.style.opacity = '1';
      setTimeout(() => t.style.opacity = '0', 2500);
    };

    const safeNumber = (v, fallback = 0) => {
      const n = Number(v);
      return Number.isFinite(n) ? n : fallback;
    };

    function haversineKm(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const toRad = (d) => (d * Math.PI) / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat / 2) ** 2 +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon / 2) ** 2;
      return 2 * R * Math.asin(Math.sqrt(a));
    }

    // --- AUTHENTICATION ---
    window.handleAuth = async (mode) => {
      const email = document.getElementById("auth-email")?.value?.trim();
      const pass = document.getElementById("auth-pass")?.value;
      if (!email || !pass) return window.showToast("Email/Pass Required");
      try {
        if (mode === "signup") {
          await createUserWithEmailAndPassword(auth, email, pass);
          window.showToast("Account Created");
        } else {
          await signInWithEmailAndPassword(auth, email, pass);
          window.showToast("Welcome Back");
        }
      } catch (e) {
        console.error(e);
        if (e?.code === 'auth/operation-not-allowed') {
          window.showToast("Enable Email/Password in Firebase Auth.");
        } else {
          window.showToast(String(e?.message || e).replace("Firebase: ", ""));
        }
      }
    };

    window.handleSignOut = async () => {
      await signOut(auth);
      window.showToast("Signed Out");
      location.reload();
    };

    // --- CLOUD SYNC ---
    function syncData() {
      if (!user) return;
      const docRef = doc(db, "artifacts", activeAppId, "users", user.uid, "projectData", "currentJob");
      onSnapshot(docRef, (snap) => {
        if (snap.exists()) {
          window.state = { ...window.state, ...snap.data() };
          window.updateUI();
        } else {
          // first time: write defaults so doc exists
          window.saveToCloud();
        }
      }, (err) => console.error("Firestore Error:", err));
    }

    window.saveToCloud = async () => {
      if (!user) return;
      const docRef = doc(db, "artifacts", activeAppId, "users", user.uid, "projectData", "currentJob");
      try {
        await setDoc(docRef, window.state, { merge: true });
      } catch (e) {
        console.error("Save Error", e);
        window.showToast("Save failed (check rules).");
      }
    };

    // --- DOM SAFE AUTH LISTENER ---
    window.addEventListener('DOMContentLoaded', () => {
      onAuthStateChanged(auth, (u) => {
        user = u;
        const viewAuth = document.getElementById('view-auth');
        const mainApp = document.getElementById('main-app-container');
        const bottomNav = document.getElementById('bottom-nav');

        if (!viewAuth || !mainApp || !bottomNav) {
          console.error("Missing DOM element(s):", {
            viewAuth: !!viewAuth, mainApp: !!mainApp, bottomNav: !!bottomNav
          });
          return;
        }

        if (user) {
          viewAuth.classList.add('hidden');
          mainApp.classList.remove('hidden');
          bottomNav.classList.remove('hidden');
          seedPlantDropdown();
          refreshTruckSelect();
          syncData();
          window.updateUI();
        } else {
          viewAuth.classList.remove('hidden');
          mainApp.classList.add('hidden');
          bottomNav.classList.add('hidden');
        }
      });
    });

    // --- UI HELPERS ---
    function seedPlantDropdown() {
      const pN = document.getElementById('setup-plant-name');
      if (!pN) return;
      pN.innerHTML =
        '<option value="">Select Facility</option>' +
        PLANT_DB.map(p => `<option value="${p.name}">${p.name}</option>`).join('');
    }

    function refreshTruckSelect() {
      const sel = document.getElementById('new-load-truck');
      if (!sel) return;
      const fleet = window.state.fleet || [];
      const options = [
        `<option value="">Manual</option>`,
        ...fleet.map(t => `<option value="${t.id}">${t.id}${t.driver ? " — " + t.driver : ""}</option>`)
      ];
      sel.innerHTML = options.join('');
    }

    window.updateUI = () => {
      const s = window.state;
      const loads = s.loads || [];
      const received = loads.reduce((sum, l) => sum + safeNumber(l.tons, 0), 0);
      const currentCount = loads.length;
      const liveAvg = currentCount > 0 ? (received / currentCount) : (safeNumber(s.avgTruckSize, 18.0));
      const totalGoal = safeNumber(s.totalGoal, 0);
      const remaining = Math.max(0, totalGoal - received);
      const progress = totalGoal > 0 ? (received / totalGoal) * 100 : 0;

      const updateText = (id, val) => { const el = document.getElementById(id); if (el) el.innerText = val; };

      updateText('display-loads-count', currentCount);
      updateText('display-loads-goal', s.plannedLoads || "--");
      updateText('display-received', received.toFixed(1));
      updateText('display-remaining', remaining.toFixed(1));
      updateText('display-avg-size', liveAvg.toFixed(1));

      const pb = document.getElementById('progress-bar');
      if (pb) pb.style.width = `${Math.min(100, progress)}%`;

      const header = document.getElementById('header-job-name');
      if (header) {
        header.innerText = (s.jobPo && s.jobAddress) ? `${s.jobPo} - ${s.jobAddress}` : (s.jobPo || s.jobAddress || "Load Console");
      }

      updateText('display-plant-name', s.plantName || "No Plant Selected");
      updateText('display-sales-rep', s.salesRep || "No Sales Rep Set");
      updateText('travel-forward', `${s.travelTimeForward ? s.travelTimeForward : '--'} m`);
      updateText('travel-return', `${s.travelTimeReturn ? s.travelTimeReturn : '--'} m`);

      const callBtn = document.getElementById('sales-rep-call-btn');
      if (callBtn) {
        if (s.salesRepPhone) {
          callBtn.href = `tel:${String(s.salesRepPhone).replace(/[^0-9]/g, '')}`;
          callBtn.classList.remove('hidden');
        } else callBtn.classList.add('hidden');
      }

      // If settings tab, hydrate fields + dropdown selection
      if (s.activeTab === 'settings') {
        const setVal = (id, val) => { const el = document.getElementById(id); if (el) el.value = (val ?? ""); };
        setVal('setup-job-address', s.jobAddress);
        setVal('setup-job-po', s.jobPo);
        setVal('setup-job-sf', s.jobSf);
        setVal('setup-plant-address', s.plantAddress);
        setVal('setup-sales-rep', s.salesRep);
        setVal('setup-sales-phone', s.salesRepPhone);
        setVal('setup-total-tons', s.totalGoal);
        setVal('setup-planned-loads', s.plannedLoads);
        setVal('setup-depth', s.inches);
        setVal('setup-plant-close', s.plantClosing);

        const pN = document.getElementById('setup-plant-name');
        if (pN) {
          // ensure options exist
          if (!pN.options || pN.options.length <= 1) seedPlantDropdown();
          pN.value = s.plantName || "";
        }
      }

      // Show/hide tabs
      const viewMap = {
        dashboard: 'view-dashboard',
        fleet: 'view-fleet',
        settings: 'view-settings'
      };
      Object.values(viewMap).forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.add('hidden');
      });
      const activeView = document.getElementById(viewMap[s.activeTab] || 'view-dashboard');
      if (activeView) activeView.classList.remove('hidden');

      // Nav styling
      ['dashboard', 'fleet', 'settings'].forEach(tab => {
        const navBtn = document.getElementById(`nav-${tab}`);
        if (!navBtn) return;
        navBtn.className = `flex flex-col items-center p-2 ${s.activeTab === tab ? 'tab-active' : 'text-slate-500'} transition-all`;
        const label = navBtn.querySelector('.nav-label');
        if (label) label.className = `nav-label text-[9px] font-black mt-1 uppercase tracking-widest ${s.activeTab === tab ? 'text-[#facc15]' : 'text-slate-400'}`;
      });

      refreshTruckSelect();
      window.renderHistory();
      window.calculateLogistics();
      window.calculateYield();
      if (s.activeTab === 'fleet') window.renderFleet();
    };

    window.switchTab = (tab) => {
      window.closeReport(); // safe no-op if not open
      window.state.activeTab = tab;
      window.updateUI();
      window.saveToCloud();
    };

    window.renderHistory = () => {
      const list = document.getElementById('load-list');
      if (!list) return;
      const loads = window.state.loads || [];
      list.innerHTML = loads.map((l, i) => `
        <div class="p-4 flex justify-between items-center hover:bg-yellow-50 transition border-l-4 border-transparent hover:border-yellow-400 bg-white">
          <div class="text-black">
            <div class="flex items-center space-x-2">
              <span class="text-[10px] font-black bg-slate-900 text-yellow-400 px-2 py-0.5 rounded italic">Load #${loads.length - i}</span>
              <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Unit ${l.truckId || "Manual"}</span>
            </div>
            <p class="font-black text-2xl text-slate-900 leading-none mt-2">${safeNumber(l.tons, 0).toFixed(2)} <span class="text-sm text-slate-400 font-bold uppercase tracking-tighter italic">tons</span></p>
          </div>
          <div class="flex flex-col items-end space-y-2">
            <span class="text-[10px] font-black text-slate-500 bg-slate-200 px-2 py-1 rounded-md border border-slate-300 shadow-sm">${l.time || "--:--"}</span>
            <button onclick="removeLoad(${l.id})" class="text-slate-300 hover:text-red-500 transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 256 256"><path d="M216,48H176V40a24,24,0,0,0-24-24H104A24,24,0,0,0,80,40v8H40a8,8,0,0,0,0,16h8V208a16,16,0,0,0,16,16H192a16,16,0,0,0,16-16V64h8a8,8,0,0,0,0-16ZM96,40a8,8,0,0,1,8-8h48a8,8,0,0,1,8,8v8H96Zm96,168H64V64H192ZM112,104v64a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Zm48,0v64a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Z"></path></svg>
            </button>
          </div>
        </div>
      `).join('') || '<div class="p-12 text-center text-slate-400 italic text-sm font-medium">No loads recorded.</div>';
    };

    window.calculateYield = () => {
      const sfInput = document.getElementById('input-sf');
      if (!sfInput) return;

      const sf = safeNumber(sfInput.value, 0);
      const inches = safeNumber(window.state.inches, 0);
      const theo = (sf / 159) * inches;

      const rec = (window.state.loads || []).reduce((sum, l) => sum + safeNumber(l.tons, 0), 0);

      const tEl = document.getElementById('display-theoretical');
      if (tEl) tEl.innerText = theo.toFixed(1);

      const badge = document.getElementById('yield-badge');
      const card = document.getElementById('yield-card');
      if (!badge || !card) return;

      if (sf === 0 || rec === 0 || theo === 0) {
        badge.innerText = "READY";
        badge.className = "px-2 py-1 rounded text-[10px] font-black bg-slate-800 uppercase text-slate-500 border border-yellow-400/10";
        card.classList.remove('heavy-glow');
        return;
      }

      const v = rec / theo;
      if (v > 1.05) {
        badge.innerText = "HEAVY";
        badge.className = "px-2 py-1 rounded text-[10px] font-black bg-red-600 uppercase text-white";
        card.classList.add('heavy-glow');
      } else if (v < 0.95) {
        badge.innerText = "LIGHT";
        badge.className = "px-2 py-1 rounded text-[10px] font-black bg-yellow-400 uppercase text-black";
        card.classList.remove('heavy-glow');
      } else {
        badge.innerText = "ON TARGET";
        badge.className = "px-2 py-1 rounded text-[10px] font-black bg-green-500 uppercase text-white";
        card.classList.remove('heavy-glow');
      }
    };

    window.calculateLogistics = () => {
      const s = window.state;
      const now = new Date();

      const [hours, mins] = String(s.plantClosing || "15:30").split(':');
      const closeDate = new Date();
      closeDate.setHours(safeNumber(hours, 15), safeNumber(mins, 30), 0, 0);

      const cutoffDate = new Date(closeDate.getTime() - (safeNumber(s.travelTimeReturn, 0) + 10) * 60000);
      const diffMins = Math.floor((cutoffDate - now) / 60000);

      const ctEl = document.getElementById('display-cutoff-time');
      const cdEl = document.getElementById('display-countdown');
      const cardEl = document.getElementById('cutoff-card');

      if (cdEl && cardEl) {
        if (diffMins < 0) {
          cdEl.innerText = "CUTOFF EXCEEDED";
          cdEl.className = "text-[10px] text-white font-black animate-pulse mt-1 uppercase";
          cardEl.className = "bg-red-600 rounded-xl shadow-sm p-4 flex flex-col justify-between transition-all duration-500 text-white";
          if (ctEl) {
            ctEl.innerText = cutoffDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            ctEl.className = "text-2xl font-black tabular-nums text-white";
          }
        } else {
          cdEl.innerText = `Exit site by ${cutoffDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
          cdEl.className = "text-[10px] text-slate-500 font-black mt-1 uppercase";
          cardEl.className = "bg-white rounded-xl shadow-sm border p-4 flex flex-col justify-between transition-all duration-500 text-black";
          if (ctEl) {
            ctEl.innerText = cutoffDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            ctEl.className = "text-2xl font-black tabular-nums text-slate-900";
          }
        }
      }

      const cTimeDiff = Math.floor((closeDate - now) / 60000);
      const pBanner = document.getElementById('plant-close-banner');
      const pText = document.getElementById('plant-close-text');

      if (cTimeDiff <= 120 && cTimeDiff > 0 && !s.plantBannerDismissed) {
        const remaining = Math.max(0, safeNumber(s.totalGoal, 0) - (s.loads || []).reduce((sum, l) => sum + safeNumber(l.tons, 0), 0)).toFixed(1);
        if (pBanner) pBanner.classList.remove('hidden');
        if (pText) pText.innerText = `${Math.floor(cTimeDiff/60)}h ${cTimeDiff%60}m till close. Contact plant with remaining ${remaining} tons.`;
      } else {
        if (pBanner) pBanner.classList.add('hidden');
      }
    };

    // --- SETTINGS HELPERS ---
    window.autoCalculateTonsAndLoads = () => {
      const sf = safeNumber(document.getElementById('setup-job-sf')?.value, 0);
      const inches = safeNumber(document.getElementById('setup-depth')?.value, 0);

      const tons = (sf / 159) * inches; // your formula
      const avg = safeNumber(window.state.avgTruckSize, 18);
      const loads = avg > 0 ? Math.max(0, Math.round(tons / avg)) : 0;

      const tonsEl = document.getElementById('setup-total-tons');
      const loadsEl = document.getElementById('setup-planned-loads');

      if (tonsEl) tonsEl.value = tons ? tons.toFixed(1) : "";
      if (loadsEl) loadsEl.value = loads ? loads : "";
    };

    window.handlePlantSelect = (plantName) => {
      const plant = PLANT_DB.find(p => p.name === plantName);
      if (!plant) return;
      const addrEl = document.getElementById('setup-plant-address');
      const repEl = document.getElementById('setup-sales-rep');
      const phoneEl = document.getElementById('setup-sales-phone');

      if (addrEl) addrEl.value = plant.addr || "";
      if (repEl) repEl.value = plant.rep || "";
      if (phoneEl) phoneEl.value = plant.phone || "";

      window.showToast("Plant applied");
    };

    window.findClosestPlant = () => {
      if (!navigator.geolocation) return window.showToast("Geolocation not supported.");
      window.showToast("Getting location...");
      navigator.geolocation.getCurrentPosition((pos) => {
        const { latitude, longitude } = pos.coords;

        let best = null;
        let bestKm = Infinity;
        for (const p of PLANT_DB) {
          if (!Number.isFinite(p.lat) || !Number.isFinite(p.lng)) continue;
          const km = haversineKm(latitude, longitude, p.lat, p.lng);
          if (km < bestKm) { bestKm = km; best = p; }
        }

        if (!best) return window.showToast("No plant candidates.");

        const dd = document.getElementById('setup-plant-name');
        if (dd) dd.value = best.name;
        window.handlePlantSelect(best.name);

        // Also persist into state immediately (so dashboard updates)
        window.state.plantName = best.name;
        window.state.plantAddress = best.addr || "";
        window.state.salesRep = best.rep || "";
        window.state.salesRepPhone = best.phone || "";
        window.saveToCloud();
        window.updateUI();

        window.showToast(`Closest: ${best.name}`);
      }, () => {
        window.showToast("Location denied. Allow location to use this.");
      }, { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 });
    };

    window.saveSetup = () => {
      const s = window.state;
      s.jobAddress = document.getElementById('setup-job-address')?.value || "";
      s.jobPo = document.getElementById('setup-job-po')?.value || "";
      s.jobSf = document.getElementById('setup-job-sf')?.value || "";
      s.plantName = document.getElementById('setup-plant-name')?.value || "";
      s.plantAddress = document.getElementById('setup-plant-address')?.value || "";
      s.salesRep = document.getElementById('setup-sales-rep')?.value || "";
      s.salesRepPhone = document.getElementById('setup-sales-phone')?.value || "";
      s.totalGoal = safeNumber(document.getElementById('setup-total-tons')?.value, 0);
      s.plannedLoads = Math.floor(safeNumber(document.getElementById('setup-planned-loads')?.value, 0));
      s.inches = safeNumber(document.getElementById('setup-depth')?.value, 0);
      s.plantClosing = document.getElementById('setup-plant-close')?.value || "15:30";
      s.plantBannerDismissed = false;

      window.saveToCloud();
      window.updateUI();
      window.updateLiveTraffic(); // optional
      window.showToast("Settings Saved");
      window.switchTab('dashboard');
    };

    // --- FLEET + LOADS ---
    window.addLoad = () => {
      const tonsIn = document.getElementById('new-load-tons');
      const truckIn = document.getElementById('new-load-truck');
      const t = safeNumber(tonsIn?.value, 0);
      if (!t) return window.showToast("Enter Tonnage");

      const truckVal = truckIn?.value || (window.state.fleet?.[0]?.id ?? "Manual");
      window.state.loads = window.state.loads || [];
      window.state.loads.unshift({
        id: Date.now(),
        tons: t,
        truckId: truckVal || "Manual",
        time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
      });

      if (tonsIn) tonsIn.value = '';
      window.saveToCloud();
      window.updateUI();
      window.showToast("Logged");
    };

    window.removeLoad = (id) => {
      window.state.loads = (window.state.loads || []).filter(l => l.id !== id);
      window.saveToCloud();
      window.updateUI();
    };

    window.clearHistory = () => {
      if (!confirm("Permanently erase all load records?")) return;
      window.state.loads = [];
      window.saveToCloud();
      window.updateUI();
    };

    window.addTruck = () => {
      const id = (document.getElementById('fleet-id')?.value || "").trim().toUpperCase();
      if (!id) return window.showToast("ID Required");

      window.state.fleet = window.state.fleet || [];
      window.state.fleet.push({
        id,
        driver: (document.getElementById('fleet-driver')?.value || "").trim(),
        phone: (document.getElementById('fleet-phone')?.value || "").trim()
      });

      const a = ['fleet-id', 'fleet-driver', 'fleet-phone'].map(x => document.getElementById(x));
      a.forEach(el => { if (el) el.value = ""; });

      window.saveToCloud();
      window.renderFleet();
      refreshTruckSelect();
      window.showToast("Unit Added");
    };

    window.updateFleetField = (idx, field, val) => {
      if (!window.state.fleet || !window.state.fleet[idx]) return;
      window.state.fleet[idx][field] = val;
      window.saveToCloud();
      refreshTruckSelect();
      window.showToast("Synced");
    };

    window.removeTruck = (id) => {
      if (!confirm(`Remove truck ${id}?`)) return;
      window.state.fleet = (window.state.fleet || []).filter(t => t.id !== id);
      window.saveToCloud();
      window.renderFleet();
      refreshTruckSelect();
    };

    window.renderFleet = () => {
      const list = document.getElementById('fleet-list');
      if (!list) return;

      const fleet = window.state.fleet || [];
      list.innerHTML = fleet.map((t, idx) => `
        <div class="bg-white p-4 rounded-xl border-l-4 border-yellow-400 shadow-sm flex flex-col space-y-3">
          <div class="flex justify-between items-start text-black">
            <div>
              <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest leading-none mb-1 opacity-30">Unit #</p>
              <p class="font-black text-xl">${t.id}</p>
            </div>
            <div class="flex items-center space-x-2">
              ${t.phone ? `<a href="tel:${String(t.phone).replace(/[^0-9]/g, '')}" class="bg-black text-yellow-400 p-2 rounded-full shadow-lg active:bg-yellow-400 active:text-black">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 256 256"><path d="M222.37,158.46l-47.11-21.11-.13-.06a16,16,0,0,0-15.17,1.4,8.12,8.12,0,0,0-.75.56L143.16,155.3c-23.51-12.82-41.69-31-54.51-54.51l16.05-16.05a8.12,8.12,0,0,0,.56-.75,16,16,0,0,0,1.34-15.3l-.06-.13L85.44,41.43a16,16,0,0,0-18.42-9.28L35,39.69a16,16,0,0,0-12.44,14c-1.56,22.25,2.4,59.3,27.1,95s72.71,114.65,138.81,114.65l6.53,0a16,16,0,0,0,14.07-12.44l7.54-32A16,16,0,0,0,222.37,158.46Z"></path></svg>
              </a>` : ''}
              <button onclick="removeTruck('${t.id}')" class="text-slate-200 p-2 hover:text-red-500 font-bold">X</button>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="text-[9px] font-black text-slate-400 uppercase leading-none mb-1 block">Driver</label>
              <input type="text" value="${t.driver || ""}" onchange="updateFleetField(${idx}, 'driver', this.value)"
                     class="w-full border-b border-dashed border-slate-200 text-sm font-bold focus:border-yellow-400 py-1 bg-transparent">
            </div>
            <div>
              <label class="text-[9px] font-black text-slate-400 uppercase leading-none mb-1 block">Phone</label>
              <input type="tel" value="${t.phone || ""}" onchange="updateFleetField(${idx}, 'phone', this.value)"
                     class="w-full border-b border-dashed border-slate-200 text-sm font-bold focus:border-yellow-400 py-1 bg-transparent">
            </div>
          </div>
        </div>
      `).join('') || '<p class="p-8 text-center text-slate-400 italic font-bold">Add units manually.</p>';
    };

    // --- REPORT ---
    window.generateReport = () => {
      const s = window.state;
      const loads = s.loads || [];
      const rec = loads.reduce((sum, l) => sum + safeNumber(l.tons, 0), 0);

      const sfI = document.getElementById('input-sf');
      const sf = sfI ? safeNumber(sfI.value, 0) : 0;
      const inches = safeNumber(s.inches, 0);
      const theo = (sf / 159) * inches;

      const variancePct = (sf > 0 && theo > 0) ? ((rec / theo) * 100 - 100) : 0;
      const v = variancePct.toFixed(1);

      const set = (id, val) => { const el = document.getElementById(id); if (el) el.innerText = val; };

      set('report-date', new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }));
      set('report-job-title', (s.jobPo ? s.jobPo + " - " : "") + (s.jobAddress || "DAILY LOG"));
      set('report-received-val', rec.toFixed(1) + " t");
      set('report-depth', (inches || 0) + '"');
      set('report-yield', (variancePct > 0 ? "+" : "") + v + "%");

      const rB = document.getElementById('report-table-body');
      if (rB) {
        rB.innerHTML = loads.map((l, i) => `
          <tr>
            <td class="p-3 border">${loads.length - i}</td>
            <td class="p-3 border text-center font-bold">${l.time || "--:--"}</td>
            <td class="p-3 border text-center font-black uppercase">${l.truckId || "Manual"}</td>
            <td class="p-3 border text-right font-black">${safeNumber(l.tons, 0).toFixed(2)}</td>
          </tr>
        `).join('');
      }

      const appWrap = document.getElementById('app');
      const report = document.getElementById('report-view');
      if (appWrap) appWrap.classList.add('hidden');
      if (report) report.classList.remove('hidden');

      window.scrollTo(0, 0);
    };

    window.closeReport = () => {
      const appWrap = document.getElementById('app');
      const report = document.getElementById('report-view');
      if (report && !report.classList.contains('hidden')) {
        report.classList.add('hidden');
      }
      if (appWrap) appWrap.classList.remove('hidden');
    };

    // --- BANNERS ---
    window.dismissPlantBanner = () => {
      window.state.plantBannerDismissed = true;
      window.saveToCloud();
      const b = document.getElementById('plant-close-banner');
      if (b) b.classList.add('hidden');
    };

    // --- AI HELPERS (optional) ---
    async function callGemini(payload) {
      if (!GEMINI_API_KEY) {
        window.showToast("AI disabled (set window.GEMINI_API_KEY).");
        throw new Error("Missing GEMINI_API_KEY");
      }
      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!response.ok) throw new Error(`Gemini HTTP ${response.status}`);
      return await response.json();
    }

    window.updateLiveTraffic = async (isAuto = false) => {
      const j = window.state.jobAddress;
      const p = window.state.plantAddress;
      if (!j || !p) return window.showToast("Set job + plant address first.");

      if (!GEMINI_API_KEY) {
        // Safe fallback: keep whatever times already set
        window.showToast("Traffic AI disabled (set window.GEMINI_API_KEY).");
        return;
      }

      if (!isAuto) window.showToast("Updating Traffic...");
      try {
        const payload = {
          contents: [{
            parts: [{
              text:
`Estimate Super10 dump truck drive times.
Route1: "${p}" to "${j}"
Route2: "${j}" to "${p}"

Return JSON ONLY:
{ "forward_mins": number, "return_mins": number, "incident": "string or null" }`
            }]
          }],
          systemInstruction: { parts: [{ text: "Return JSON only, no prose." }] }
        };

        const result = await callGemini(payload);
        const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || "";
        const match = text.match(/\{.*\}/s);
        const data = JSON.parse(match ? match[0] : "{}");

        if (data.forward_mins) {
          const s = window.state;
          if (!s.baselineForward) s.baselineForward = data.forward_mins;
          if (!s.baselineReturn) s.baselineReturn = data.return_mins;
          s.travelTimeForward = data.forward_mins;
          s.travelTimeReturn = data.return_mins;
          s.trafficIncident = data.incident || null;

          checkTrafficAnomalies(data.forward_mins, data.return_mins);
          window.saveToCloud();
          window.updateUI();
          window.showToast("Traffic updated");
        } else {
          window.showToast("No traffic JSON returned");
        }
      } catch (e) {
        console.error(e);
        window.showToast("Traffic update failed");
      }
    };

    function checkTrafficAnomalies(fwd, ret) {
      const s = window.state;
      const widget = document.getElementById('travel-widget');
      const banner = document.getElementById('traffic-delay-banner');

      const baseF = safeNumber(s.baselineForward, fwd);
      const baseR = safeNumber(s.baselineReturn, ret);

      const isPulsing = (fwd > baseF * 1.15) || (ret > baseR * 1.15);
      if (widget) {
        widget.className = `bg-white rounded-2xl shadow-xl border-2 border-slate-200 overflow-hidden ring-4 ring-slate-100 transition-all duration-500 ${isPulsing ? 'pulse-border' : ''}`;
      }

      if (((fwd > baseF * 1.30) || (ret > baseR * 1.30)) && banner) {
        banner.classList.remove('hidden');
        const t = document.getElementById('traffic-delay-text');
        if (t) t.innerText = `Major traffic delay. Times: ${fwd}m / ${ret}m. Check route.`;
      }
    }

    // --- SCAN ---
    window.triggerScanner = () => {
      const f = document.getElementById('ticket-file');
      if (!f) return;
      f.click();
    };

    window.handleImageUpload = async (event) => {
      const file = event.target.files?.[0];
      if (!file) return;

      const label = document.getElementById('scanner-text');
      if (label) label.innerText = "Analyzing...";

      if (!GEMINI_API_KEY) {
        window.showToast("Scan AI disabled (set window.GEMINI_API_KEY).");
        if (label) label.innerText = "Scan Weigh Ticket";
        return;
      }

      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = async () => {
        const base64 = String(reader.result).split(',')[1];

        try {
          const payload = {
            contents: [{
              parts: [
                { text: "Extract Net Tons and Truck ID from this weigh ticket image. Return JSON only: {\"tons\": number, \"truckId\": string}" },
                { inlineData: { mimeType: file.type || "image/png", data: base64 } }
              ]
            }],
            systemInstruction: { parts: [{ text: "Return JSON only." }] }
          };

          const result = await callGemini(payload);
          const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || "";
          const match = text.match(/\{.*\}/s);
          const data = JSON.parse(match ? match[0] : "{}");

          if (data.tons) {
            window.state.loads = window.state.loads || [];
            window.state.loads.unshift({
              id: Date.now(),
              tons: safeNumber(data.tons, 0),
              truckId: String(data.truckId || "UNKNOWN").toUpperCase(),
              time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
            });
            window.saveToCloud();
            window.updateUI();
            window.showToast(`Logged ${safeNumber(data.tons, 0).toFixed(2)}t`);
          } else {
            window.showToast("Could not read tons");
          }
        } catch (e) {
          console.error(e);
          window.showToast("Scan Failed");
        } finally {
          if (label) label.innerText = "Scan Weigh Ticket";
          event.target.value = ""; // reset file input
        }
      };
    };
  </script>
</body>
</html>
